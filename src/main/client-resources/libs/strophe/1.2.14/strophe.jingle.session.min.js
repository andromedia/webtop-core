function JingleSession(e,i,t){this.me=e,this.sid=i,this.connection=t,this.initiator=null,this.responder=null,this.isInitiator=null,this.peerjid=null,this.state=null,this.peerconnection=null,this.remoteStream=null,this.localSDP=null,this.remoteSDP=null,this.localStreams=[],this.relayedStreams=[],this.remoteStreams=[],this.startTime=null,this.stopTime=null,this.media_constraints=null,this.pc_constraints=null,this.ice_config={},this.drip_container=[],this.usetrickle=!0,this.usepranswer=!1,this.usedrip=!1,this.hadstuncandidate=!1,this.hadturncandidate=!1,this.lasticecandidate=!1,this.statsinterval=null,this.reason=null,this.addssrc=[],this.removessrc=[],this.pendingop=null,this.wait=!0,this.nickname=null,this.startmuted=!1,this.filter_candidates=null}JingleSession.prototype.initiate=function(e,i){var t=this;if(null===this.state){this.isInitiator=i,this.state="pending",this.initiator=i?this.me:e,this.responder=i?e:this.me,this.peerjid=e;try{this.peerconnection=new RTCPeerconnection(this.ice_config,this.pc_constraints)}catch(e){return console.error("Failed to create PeerConnection, exception: ",e.message),void console.error(e)}this.hadstuncandidate=!1,this.hadturncandidate=!1,this.lasticecandidate=!1,this.peerconnection.onicecandidate=function(e){t.sendIceCandidate(e.candidate)},this.peerconnection.onaddstream=function(e){t.remoteStream=e.stream,t.remoteStreams.push(e.stream),$(document).trigger("remotestreamadded.jingle",[e,t.sid])},this.peerconnection.onremovestream=function(e){t.remoteStream=null,$(document).trigger("remotestreamremoved.jingle",[e,t.sid])},this.peerconnection.onsignalingstatechange=function(e){t&&t.peerconnection},this.peerconnection.oniceconnectionstatechange=function(e){if(t&&t.peerconnection){switch(t.peerconnection.iceConnectionState){case"connected":this.startTime=new Date;break;case"disconnected":this.stopTime=new Date}$(document).trigger("iceconnectionstatechange.jingle",[t.sid,t])}},this.localStreams.forEach(function(e){t.peerconnection.addStream(e)}),this.relayedStreams.forEach(function(e){t.peerconnection.addStream(e)})}else console.error("attempt to initiate on session "+this.sid+"in state "+this.state)},JingleSession.prototype.accept=function(){var e=this;this.state="active";var i=this.peerconnection.localDescription;if(i&&"pranswer"==i.type){if(console.log("going from pranswer to answer"),this.usetrickle)for(var t=SDPUtil.find_lines(i.sdp,"a=candidate:"),n=0;n<t.length;n++)i.sdp=i.sdp.replace(t[n]+"\r\n","");for(;SDPUtil.find_line(i.sdp,"a=inactive");)i.sdp=i.sdp.replace("a=inactive","a=sendrecv");var o=new SDP(i.sdp),s=$iq({to:this.peerjid,type:"set"}).c("jingle",{xmlns:"urn:xmpp:jingle:1",action:"session-accept",initiator:this.initiator,responder:this.responder,sid:this.sid});o.toJingle(s,this.initiator==this.me?"initiator":"responder"),this.connection.sendIQ(s,function(){var i={source:"answer"};$(document).trigger("ack.jingle",[e.sid,i])},function(i){var t=$(i).find("error").length?{code:$(i).find("error").attr("code"),reason:$(i).find("error :first")[0].tagName}:{};t.source="answer",$(document).trigger("error.jingle",[e.sid,t])},1e4);for(var r=this.peerconnection.localDescription.sdp;SDPUtil.find_line(r,"a=inactive");)r=r.replace("a=inactive","a=sendrecv");this.peerconnection.setLocalDescription(new RTCSessionDescription({type:"answer",sdp:r}),function(){$(document).trigger("setLocalDescription.jingle",[e.sid])},function(e){console.error("setLocalDescription failed",e)})}},JingleSession.prototype.terminate=function(e){this.state="ended",this.reason=e,this.peerconnection.close(),null!==this.statsinterval&&(window.clearInterval(this.statsinterval),this.statsinterval=null)},JingleSession.prototype.active=function(){return"active"==this.state},JingleSession.prototype.sendIceCandidate=function(e){var i=this;if(e&&!this.lasticecandidate){var t=SDPUtil.iceparams(this.localSDP.media[e.sdpMLineIndex],this.localSDP.session),n=SDPUtil.candidateToJingle(e.candidate);if(!t||!n)return void console.error("failed to get ice && jcand");if(t.xmlns="urn:xmpp:jingle:transports:ice-udp:1","srflx"===n.type?this.hadstuncandidate=!0:"relay"===n.type&&(this.hadturncandidate=!0),(null===this.filter_candidates||n.type===this.filter_candidates)&&this.usetrickle){if(console.log("sendIceCandidate using trickle"),this.usedrip)return 0===this.drip_container.length&&window.setTimeout(function(){console.log("sending drip container"),0!==i.drip_container.length&&(i.sendIceCandidates(i.drip_container),i.drip_container=[])},20),void this.drip_container.push(event.candidate);console.log("sending single candidate"),i.sendIceCandidates([event.candidate])}}else{if(console.log("sendIceCandidate: last candidate..."),!this.usetrickle){console.log("should send full offer now...");var o=$iq({to:this.peerjid,type:"set"}).c("jingle",{xmlns:"urn:xmpp:jingle:1",action:"offer"==this.peerconnection.localDescription.type?"session-initiate":"session-accept",initiator:this.initiator,sid:this.sid});null!==this.nickname&&o.c("nick",{xmlns:"http://jabber.org/protocol/nick"}).t(this.nickname).up(),this.startmuted&&o.c("muted",{xmlns:"http://jitsi.org/protocol/meet#startmuted"}).up(),this.localSDP=new SDP(this.peerconnection.localDescription.sdp),this.localSDP.toJingle(o,this.initiator==this.me?"initiator":"responder"),console.log("try to send ack(offer)..."),this.connection.sendIQ(o,function(){console.log("Sent session initiate (ACK, offer)...");var e={source:"offer"};$(document).trigger("ack.jingle",[i.sid,e])},function(e){i.state="error",i.peerconnection.close();var t=$(e).find("error").length?{code:$(e).find("error").attr("code"),reason:$(e).find("error :first")[0].tagName}:{};t.source="offer",$(document).trigger("error.jingle",[i.sid,t])},1e4)}this.lasticecandidate=!0,console.log("Have we encountered any srflx candidates? "+this.hadstuncandidate),console.log("Have we encountered any relay candidates? "+this.hadturncandidate),this.hadstuncandidate||this.hadturncandidate||"closed"==this.peerconnection.signalingState||(console.log("no candidates found!"),$(document).trigger("nostuncandidates.jingle",[this.sid]))}},JingleSession.prototype.sendIceCandidates=function(e){console.log("sendIceCandidates",e);for(var i=$iq({to:this.peerjid,type:"set"}).c("jingle",{xmlns:"urn:xmpp:jingle:1",action:"transport-info",initiator:this.initiator,sid:this.sid}),t=0;t<this.localSDP.media.length;t++){var n=e.filter(function(e){return e.sdpMLineIndex==t}),o=SDPUtil.parse_mline(this.localSDP.media[t].split("\r\n")[0]);if(n.length>0){var s=SDPUtil.iceparams(this.localSDP.media[t],this.localSDP.session);s.xmlns="urn:xmpp:jingle:transports:ice-udp:1",i.c("content",{creator:this.initiator==this.me?"initiator":"responder",name:n[0].sdpMid?n[0].sdpMid:o.media}).c("transport",s);for(var r=0;r<n.length;r++)i.c("candidate",SDPUtil.candidateToJingle(n[r].candidate)).up();if(SDPUtil.find_line(this.localSDP.media[t],"a=fingerprint:",this.localSDP.session)){var a=SDPUtil.parse_fingerprint(SDPUtil.find_line(this.localSDP.media[t],"a=fingerprint:",this.localSDP.session));a.required=!0,i.c("fingerprint").t(a.fingerprint),delete a.fingerprint,i.attrs(a),i.up()}i.up(),i.up()}}console.log("try to send ack(transportinfo)..."),this.connection.sendIQ(i,function(){var e={source:"transportinfo"};console.log("Sent session initiate (ACK, transportinfo)..."),$(document).trigger("ack.jingle",[this.sid,e])},function(e){var i=$(e).find("error").length?{code:$(e).find("error").attr("code"),reason:$(e).find("error :first")[0].tagName}:{};i.source="transportinfo",$(document).trigger("error.jingle",[this.sid,i])},1e4)},JingleSession.prototype.sendOffer=function(){var e=this;this.peerconnection.createOffer(function(i){e.createdOffer(i)},function(e){console.error("createOffer failed",e)},this.media_constraints)},JingleSession.prototype.createdOffer=function(e){var i=this;if(this.localSDP=new SDP(e.sdp),this.usetrickle){var t=$iq({to:this.peerjid,type:"set"}).c("jingle",{xmlns:"urn:xmpp:jingle:1",action:"session-initiate",initiator:this.initiator,sid:this.sid});null!==this.nickname&&t.c("nick",{xmlns:"http://jabber.org/protocol/nick"}).t(this.nickname).up(),this.startmuted&&t.c("muted",{xmlns:"http://jitsi.org/protocol/meet#startmuted"}).up(),this.localSDP.toJingle(t,this.initiator==this.me?"initiator":"responder"),this.connection.sendIQ(t,function(){var e={source:"offer"};$(document).trigger("ack.jingle",[i.sid,e])},function(e){i.state="error",i.peerconnection.close();var t=$(e).find("error").length?{code:$(e).find("error").attr("code"),reason:$(e).find("error :first")[0].tagName}:{};t.source="offer",$(document).trigger("error.jingle",[i.sid,t])},1e4)}e.sdp=this.localSDP.raw,this.peerconnection.setLocalDescription(e,function(){$(document).trigger("setLocalDescription.jingle",[i.sid])},function(e){console.error("setLocalDescription failed",e)});for(var n=SDPUtil.find_lines(this.localSDP.raw,"a=candidate:"),o=0;o<n.length;o++){var s=SDPUtil.parse_icecandidate(n[o]);"srflx"==s.type?this.hadstuncandidate=!0:"relay"==s.type&&(this.hadturncandidate=!0)}},JingleSession.prototype.setRemoteDescription=function(e,i){if(this.remoteSDP=new SDP(""),this.remoteSDP.fromJingle(e),null!==this.peerconnection.remoteDescription&&(console.log("setRemoteDescription when remote description is not null, should be pranswer",this.peerconnection.remoteDescription),"pranswer"==this.peerconnection.remoteDescription.type)){for(var t=new SDP(this.peerconnection.remoteDescription.sdp),n=0;n<t.media.length;n++){SDPUtil.find_line(this.remoteSDP.media[n],"a=ice-ufrag:",this.remoteSDP.session)||(SDPUtil.find_line(t.media[n],"a=ice-ufrag:",t.session)?this.remoteSDP.media[n]+=SDPUtil.find_line(t.media[n],"a=ice-ufrag:",t.session)+"\r\n":console.warn("no ice ufrag?"),SDPUtil.find_line(t.media[n],"a=ice-pwd:",t.session)?this.remoteSDP.media[n]+=SDPUtil.find_line(t.media[n],"a=ice-pwd:",t.session)+"\r\n":console.warn("no ice pwd?"));for(var o=SDPUtil.find_lines(t.media[n],"a=candidate:"),s=0;s<o.length;s++)this.remoteSDP.media[n]+=o[s]+"\r\n"}this.remoteSDP.raw=this.remoteSDP.session+this.remoteSDP.media.join("")}var r=new RTCSessionDescription({type:i,sdp:this.remoteSDP.raw});this.peerconnection.setRemoteDescription(r,function(){},function(e){console.error("setRemoteDescription error",e)})},JingleSession.prototype.addIceCandidate=function(e){var i=this;if("closed"!=this.peerconnection.signalingState){if(!this.peerconnection.remoteDescription&&"have-local-offer"==this.peerconnection.signalingState){if(console.log("trickle ice candidate arriving before session accept..."),!this.remoteSDP){for(var t="v=0\r\no=- 1923518516 2 IN IP4 0.0.0.0\r\ns=-\r\nt=0 0\r\n",n=0;n<this.localSDP.media.length;n++)t+=SDPUtil.find_line(this.localSDP.media[n],"m=")+"\r\n",t+=SDPUtil.find_lines(this.localSDP.media[n],"a=rtpmap:").join("\r\n")+"\r\n",SDPUtil.find_line(this.localSDP.media[n],"a=mid:")&&(t+=SDPUtil.find_line(this.localSDP.media[n],"a=mid:")+"\r\n"),t+="a=inactive\r\n";this.remoteSDP=new SDP(t)}if(e.each(function(){for(var e=0;e<i.remoteSDP.media.length;e++)if((SDPUtil.find_line(i.remoteSDP.media[e],"a=mid:"+$(this).attr("name"))||0===i.remoteSDP.media[e].indexOf("m="+$(this).attr("name")))&&!SDPUtil.find_line(i.remoteSDP.media[e],"a=ice-ufrag:")){var t=$(this).find("transport");i.remoteSDP.media[e]+="a=ice-ufrag:"+t.attr("ufrag")+"\r\n",i.remoteSDP.media[e]+="a=ice-pwd:"+t.attr("pwd")+"\r\n",(t=$(this).find("transport>fingerprint")).length?i.remoteSDP.media[e]+="a=fingerprint:"+t.attr("hash")+" "+t.text()+"\r\n":(console.log("no dtls fingerprint (webrtc issue #1718?)"),i.remoteSDP.media[e]+="a=crypto:1 AES_CM_128_HMAC_SHA1_80 inline:BAADBAADBAADBAADBAADBAADBAADBAADBAADBAAD\r\n");break}}),this.remoteSDP.raw=this.remoteSDP.session+this.remoteSDP.media.join(""),this.remoteSDP.media.filter(function(e){return SDPUtil.find_line(e,"a=ice-ufrag:")}).length==this.remoteSDP.media.length){console.log("setting pranswer");try{this.peerconnection.setRemoteDescription(new RTCSessionDescription({type:"pranswer",sdp:this.remoteSDP.raw}),function(){},function(e){console.log("setRemoteDescription pranswer failed",e.toString())})}catch(e){console.error("setting pranswer failed",e)}}}e.each(function(){var e,t=-1;for(e=0;e<i.remoteSDP.media.length;e++)if(SDPUtil.find_line(i.remoteSDP.media[e],"a=mid:"+$(this).attr("name"))||0===i.remoteSDP.media[e].indexOf("m="+$(this).attr("name"))){t=e;break}if(-1==t)for(e=0;e<i.localSDP.media.length;e++)if(SDPUtil.find_line(i.localSDP.media[e],"a=mid:"+$(this).attr("name"))||0===i.localSDP.media[e].indexOf("m="+$(this).attr("name"))){t=e;break}var n=$(this).attr("name");$(this).find("transport>candidate").each(function(){var e,o;e=SDPUtil.candidateFromJingle(this),o=new RTCIceCandidate({sdpMLineIndex:t,sdpMid:n,candidate:e});try{i.peerconnection.addIceCandidate(o)}catch(i){console.error("addIceCandidate failed",i.toString(),e)}})})}},JingleSession.prototype.sendAnswer=function(e){var i=this;this.peerconnection.createAnswer(function(t){i.createdAnswer(t,e)},function(e){console.error("createAnswer failed",e)},this.media_constraints)},JingleSession.prototype.createdAnswer=function(e,i){var t=this;if(this.localSDP=new SDP(e.sdp),this.usepranswer=!0===i,this.startmuted&&(console.log("we got a request to start muted..."),this.connection.jingle.localStream.getAudioTracks().forEach(function(e){e.enabled=!1}),this.connection.jingle.localStream.getVideoTracks().forEach(function(e){e.enabled=!1}),this.localSDP.media[1]=this.localSDP.media[1].replace("a=sendrecv","a=recvonly"),SDPUtil.find_lines(this.localSDP.media[1],"a=ssrc:").forEach(function(e){t.localSDP.media[1]=t.localSDP.media[1].replace(e+"\r\n","")}),this.localSDP.raw=this.localSDP.session+this.localSDP.media.join("")),this.usetrickle)if(this.usepranswer){e.type="pranswer";for(var n=0;n<this.localSDP.media.length;n++)this.localSDP.media[n]=this.localSDP.media[n].replace("a=sendrecv\r\n","a=inactive\r\n");this.localSDP.raw=this.localSDP.session+this.localSDP.media.join("")}else{var o=$iq({to:this.peerjid,type:"set"}).c("jingle",{xmlns:"urn:xmpp:jingle:1",action:"session-accept",initiator:this.initiator,responder:this.responder,sid:this.sid});this.localSDP.toJingle(o,this.initiator==this.me?"initiator":"responder"),this.connection.sendIQ(o,function(){var e={source:"answer"};$(document).trigger("ack.jingle",[t.sid,e])},function(e){var i=$(e).find("error").length?{code:$(e).find("error").attr("code"),reason:$(e).find("error :first")[0].tagName}:{};i.source="answer",$(document).trigger("error.jingle",[t.sid,i])},1e4)}e.sdp=this.localSDP.raw,this.peerconnection.setLocalDescription(e,function(){$(document).trigger("setLocalDescription.jingle",[t.sid])},function(e){console.error("setLocalDescription failed",e)});for(var s=SDPUtil.find_lines(this.localSDP.raw,"a=candidate:"),r=0;r<s.length;r++){var a=SDPUtil.parse_icecandidate(s[r]);"srflx"==a.type?this.hadstuncandidate=!0:"relay"==a.type&&(this.hadturncandidate=!0)}},JingleSession.prototype.sendTerminate=function(e,i){var t=this,n=$iq({to:this.peerjid,type:"set"}).c("jingle",{xmlns:"urn:xmpp:jingle:1",action:"session-terminate",initiator:this.initiator,sid:this.sid}).c("reason").c(e||"success");i&&n.up().c("text").t(i),this.connection.sendIQ(n,function(){t.peerconnection.close(),t.peerconnection=null,t.terminate();var e={source:"terminate"};$(document).trigger("ack.jingle",[t.sid,e])},function(e){var i=$(e).find("error").length?{code:$(e).find("error").attr("code"),reason:$(e).find("error :first")[0].tagName}:{};$(document).trigger("ack.jingle",[t.sid,i])},1e4),null!==this.statsinterval&&(window.clearInterval(this.statsinterval),this.statsinterval=null)},JingleSession.prototype.addSource=function(e){console.log("addssrc",(new Date).getTime()),console.log("ice",this.peerconnection.iceConnectionState);var i=new SDP(this.peerconnection.remoteDescription.sdp),t=this;$(e).each(function(e,n){var o=$(n).attr("name"),s="";tmp=$(n).find('>source[xmlns="urn:xmpp:jingle:apps:rtp:ssma:0"]'),tmp.each(function(){var e=$(this).attr("ssrc");$(this).find(">parameter").each(function(){s+="a=ssrc:"+e+" "+$(this).attr("name"),$(this).attr("value")&&$(this).attr("value").length&&(s+=":"+$(this).attr("value")),s+="\r\n"})}),i.media.forEach(function(e,n){SDPUtil.find_line(e,"a=mid:"+o)&&(i.media[n]+=s,t.addssrc[n]||(t.addssrc[n]=""),t.addssrc[n]+=s)}),i.raw=i.session+i.media.join("")}),this.modifySources()},JingleSession.prototype.removeSource=function(e){console.log("removessrc",(new Date).getTime()),console.log("ice",this.peerconnection.iceConnectionState);var i=new SDP(this.peerconnection.remoteDescription.sdp),t=this;$(e).each(function(e,n){var o=$(n).attr("name"),s="";tmp=$(n).find('>source[xmlns="urn:xmpp:jingle:apps:rtp:ssma:0"]'),tmp.each(function(){var e=$(this).attr("ssrc");$(this).find(">parameter").each(function(){s+="a=ssrc:"+e+" "+$(this).attr("name"),$(this).attr("value")&&$(this).attr("value").length&&(s+=":"+$(this).attr("value")),s+="\r\n"})}),i.media.forEach(function(e,n){SDPUtil.find_line(e,"a=mid:"+o)&&(i.media[n]+=s,t.addssrc[n]||(t.removessrc[n]=""),t.removessrc[n]+=s)}),i.raw=i.session+i.media.join("")}),this.modifySources()},JingleSession.prototype.modifySources=function(){var e=this;if("closed"!=this.peerconnection.signalingState&&(this.addssrc.length||this.removessrc.length||null!==this.pendingop)){if("stable"!=this.peerconnection.signalingState||"connected"!=this.peerconnection.iceConnectionState)return console.warn("modifySources not yet",this.peerconnection.signalingState,this.peerconnection.iceConnectionState),this.wait=!0,void window.setTimeout(function(){e.modifySources()},250);if(this.wait)return window.setTimeout(function(){e.modifySources()},2500),void(this.wait=!1);var i=new SDP(this.peerconnection.remoteDescription.sdp);this.addssrc.forEach(function(e,t){i.media[t]+=e}),this.addssrc=[],this.removessrc.forEach(function(e,t){(e=e.split("\r\n")).pop(),e.forEach(function(e){i.media[t]=i.media[t].replace(e+"\r\n","")})}),this.removessrc=[],i.raw=i.session+i.media.join(""),this.peerconnection.setRemoteDescription(new RTCSessionDescription({type:"offer",sdp:i.raw}),function(){e.peerconnection.createAnswer(function(i){if(null!==e.pendingop){var t=new SDP(i.sdp);if(t.media.length>1){switch(e.pendingop){case"mute":t.media[1]=t.media[1].replace("a=sendrecv","a=recvonly");break;case"unmute":t.media[1]=t.media[1].replace("a=recvonly","a=sendrecv")}t.raw=t.session+t.media.join(""),i.sdp=t.raw}e.pendingop=null}e.peerconnection.setLocalDescription(i,function(){$(document).trigger("setLocalDescription.jingle",[e.sid])},function(e){console.log("modified setLocalDescription failed")})},function(e){console.log("modified answer failed")})},function(e){console.log("modify failed")})}},JingleSession.prototype.hardMuteVideo=function(e){this.pendingop=e?"mute":"unmute",this.modifySources(),this.connection.jingle.localStream.getVideoTracks().forEach(function(i){i.enabled=!e})},JingleSession.prototype.sendMute=function(e,i){var t=$iq({to:this.peerjid,type:"set"}).c("jingle",{xmlns:"urn:xmpp:jingle:1",action:"session-info",initiator:this.initiator,sid:this.sid});t.c(e?"mute":"unmute",{xmlns:"urn:xmpp:jingle:apps:rtp:info:1"}),t.attrs({creator:this.me==this.initiator?"creator":"responder"}),i&&t.attrs({name:i}),this.connection.send(t)},JingleSession.prototype.sendRinging=function(){var e=$iq({to:this.peerjid,type:"set"}).c("jingle",{xmlns:"urn:xmpp:jingle:1",action:"session-info",initiator:this.initiator,sid:this.sid});e.c("ringing",{xmlns:"urn:xmpp:jingle:apps:rtp:info:1"}),this.connection.send(e)},JingleSession.prototype.getStats=function(e){var i=this,t={audio:0,video:0},n={audio:0,video:0},o={audio:0,video:0},s={audio:0,video:0},r={audio:0,video:0},a={audio:0,video:0};return this.statsinterval=window.setInterval(function(){i&&i.peerconnection&&i.peerconnection.getStats&&i.peerconnection.getStats(function(e){for(var c=e.result(),d=0;d<c.length;++d)if("ssrc"==c[d].type){var l=c[d].stat("packetsReceived"),h=c[d].stat("packetsLost");l&&h&&(l=parseInt(l,10),h=parseInt(h,10),c[d].stat("googFrameRateReceived")?(s.video=n.video,o.video=t.video,t.video=l,n.video=h):(s.audio=n.audio,o.audio=t.audio,t.audio=l,n.audio=h))}a.audio=t.audio-o.audio,a.video=t.video-o.video,r.audio=a.audio>0?Math.ceil(100*(n.audio-s.audio)/a.audio):0,r.video=a.video>0?Math.ceil(100*(n.video-s.video)/a.video):0,$(document).trigger("packetloss.jingle",[i.sid,r])})},e||3e3),this.statsinterval};