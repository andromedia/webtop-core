Strophe.addConnectionPlugin("jingle",{connection:null,sessions:{},jid2session:{},ice_config:{iceServers:[]},pc_constraints:{},media_constraints:{mandatory:{OfferToReceiveAudio:!0,OfferToReceiveVideo:!0}},localStream:null,init:function(e){this.connection=e,this.connection.disco&&(this.connection.disco.addFeature("urn:xmpp:jingle:1"),this.connection.disco.addFeature("urn:xmpp:jingle:apps:rtp:1"),this.connection.disco.addFeature("urn:xmpp:jingle:transports:ice-udp:1"),this.connection.disco.addFeature("urn:xmpp:jingle:apps:rtp:audio"),this.connection.disco.addFeature("urn:xmpp:jingle:apps:rtp:video"),this.connection.disco.addFeature("urn:ietf:rfc:5761")),this.connection.addHandler(this.onJingle.bind(this),"urn:xmpp:jingle:1","iq","set",null,null)},onJingle:function(e){var n=$(e).find("jingle").attr("sid"),i=$(e).find("jingle").attr("action"),t=$iq({type:"result",to:e.getAttribute("from"),id:e.getAttribute("id")}),s=this.sessions[n];if("session-initiate"!=i){if(null===s)return t.type="error",t.c("error",{type:"cancel"}).c("item-not-found",{xmlns:"urn:ietf:params:xml:ns:xmpp-stanzas"}).up().c("unknown-session",{xmlns:"urn:xmpp:jingle:errors:1"}),this.connection.send(t),!0;if(Strophe.getBareJidFromJid(e.getAttribute("from"))!=Strophe.getBareJidFromJid(s.peerjid))return console.warn("jid mismatch for session id",n,e.getAttribute("from"),s.peerjid),t.type="error",t.c("error",{type:"cancel"}).c("item-not-found",{xmlns:"urn:ietf:params:xml:ns:xmpp-stanzas"}).up().c("unknown-session",{xmlns:"urn:xmpp:jingle:errors:1"}),this.connection.send(t),!0}else if(void 0!==s)return t.type="error",t.c("error",{type:"cancel"}).c("service-unavailable",{xmlns:"urn:ietf:params:xml:ns:xmpp-stanzas"}).up(),console.warn("duplicate session id",n),this.connection.send(t),!0;switch(this.connection.send(t),i){case"session-initiate":s=new JingleSession($(e).attr("to"),$(e).find("jingle").attr("sid"),this.connection),this.localStream&&s.localStreams.push(this.localStream),s.media_constraints=this.media_constraints,s.pc_constraints=this.pc_constraints,s.ice_config=this.ice_config,s.initiate($(e).attr("from"),!1),s.setRemoteDescription($(e).find(">jingle"),"offer"),this.sessions[s.sid]=s,this.jid2session[s.peerjid]=s,$(document).trigger("callincoming.jingle",[s.sid]);break;case"session-accept":s.setRemoteDescription($(e).find(">jingle"),"answer"),s.accept(),$(document).trigger("callaccepted.jingle",[s.sid]);break;case"session-terminate":s.terminate(),this.terminate(s.sid),$(e).find(">jingle>reason").length?$(document).trigger("callterminated.jingle",[s.sid,$(e).find(">jingle>reason>:first")[0].tagName,$(e).find(">jingle>reason>text").text()]):$(document).trigger("callterminated.jingle",[s.sid]);break;case"transport-info":s.addIceCandidate($(e).find(">jingle>content"));break;case"session-info":var r;$(e).find('>jingle>ringing[xmlns="urn:xmpp:jingle:apps:rtp:info:1"]').length?$(document).trigger("ringing.jingle",[s.sid]):$(e).find('>jingle>mute[xmlns="urn:xmpp:jingle:apps:rtp:info:1"]').length?(r=$(e).find('>jingle>mute[xmlns="urn:xmpp:jingle:apps:rtp:info:1"]').attr("name"),$(document).trigger("mute.jingle",[s.sid,r])):$(e).find('>jingle>unmute[xmlns="urn:xmpp:jingle:apps:rtp:info:1"]').length&&(r=$(e).find('>jingle>unmute[xmlns="urn:xmpp:jingle:apps:rtp:info:1"]').attr("name"),$(document).trigger("unmute.jingle",[s.sid,r]));break;case"addsource":s.addSource($(e).find(">jingle>content"));break;case"removesource":s.removeSource($(e).find(">jingle>content"));break;default:console.warn("jingle action not implemented",i)}return!0},initiate:function(e,n){var i=new JingleSession(n||this.connection.jid,Math.random().toString(36).substr(2,12),this.connection);return this.localStream&&i.localStreams.push(this.localStream),i.media_constraints=this.media_constraints,i.pc_constraints=this.pc_constraints,i.ice_config=this.ice_config,i.initiate(e,!0),this.sessions[i.sid]=i,this.jid2session[i.peerjid]=i,i.sendOffer(),i},terminate:function(e,n,i){if(null==e)for(e in this.sessions)"ended"!=this.sessions[e].state&&(this.sessions[e].sendTerminate(n||!this.sessions[e].active()?"cancel":null,i),this.sessions[e].terminate()),delete this.jid2session[this.sessions[e].peerjid],delete this.sessions[e];else this.sessions.hasOwnProperty(e)&&("ended"!=this.sessions[e].state&&(this.sessions[e].sendTerminate(n||!this.sessions[e].active()?"cancel":null,i),this.sessions[e].terminate()),delete this.jid2session[this.sessions[e].peerjid],delete this.sessions[e])},terminateByJid:function(e){if(this.jid2session.hasOwnProperty(e)){var n=this.jid2session[e];n&&(n.terminate(),delete this.sessions[n.sid],delete this.jid2session[e],$(document).trigger("callterminated.jingle",[n.sid,"gone"]))}},getStunAndTurnCredentials:function(){var e=this;this.connection.sendIQ($iq({type:"get",to:this.connection.domain}).c("services",{xmlns:"urn:xmpp:extdisco:1"}).c("service",{host:"turn."+this.connection.domain}),function(n){var i=[];$(n).find(">services>service").each(function(e,n){var t={};switch((n=$(n)).attr("type")){case"stun":t.url="stun:"+n.attr("host"),n.attr("port")&&(t.url+=":"+n.attr("port")),i.push(t);break;case"turn":t.url="turn:",n.attr("username")&&(t.username=n.attr("username")),t.url+=n.attr("host"),n.attr("port")&&"3478"!=n.attr("port")&&(t.url+=":"+n.attr("port")),n.attr("transport")&&"udp"!=n.attr("transport")&&(t.url+="?transport="+n.attr("transport")),n.attr("password")&&(t.credential=n.attr("password")),i.push(t)}}),e.ice_config.iceServers=i},function(e){console.warn("getting turn credentials failed",e),console.warn("is mod_turncredentials or similar installed?")})}});