function SDP(t){this.media=t.split("\r\nm=");for(var i=1;i<this.media.length;i++)this.media[i]="m="+this.media[i],i!=this.media.length-1&&(this.media[i]+="\r\n");this.session=this.media.shift()+"\r\n",this.raw=this.session+this.media.join("")}SDP.prototype.mangle=function(){var t,i,e,n,r,s;for(t=0;t<this.media.length;t++)if((n=this.media[t].split("\r\n")).pop(),"audio"==(e=SDPUtil.parse_mline(n.shift())).media){for(s="",e.fmt.length=0,i=0;i<n.length;i++)if("a=rtpmap:"==n[i].substr(0,9)){if("CN"==(r=SDPUtil.parse_rtpmap(n[i])).name||"ISAC"==r.name)continue;e.fmt.push(r.id),s+=n[i]+"\r\n"}else s+=n[i]+"\r\n";this.media[t]=SDPUtil.build_mline(e)+"\r\n",this.media[t]+=s}this.raw=this.session+this.media.join("")},SDP.prototype.removeSessionLines=function(t){var i=this,e=SDPUtil.find_lines(this.session,t);return e.forEach(function(t){i.session=i.session.replace(t+"\r\n","")}),this.raw=this.session+this.media.join(""),e},SDP.prototype.removeMediaLines=function(t,i){var e=this,n=SDPUtil.find_lines(this.media[t],i);return n.forEach(function(i){e.media[t]=e.media[t].replace(i+"\r\n","")}),this.raw=this.session+this.media.join(""),n},SDP.prototype.toJingle=function(t,i){var e,n,r,s,a,p,o,l;if(SDPUtil.find_line(this.session,"a=group:"))for(l=SDPUtil.find_lines(this.session,"a=group:"),e=0;e<l.length;e++){var u=(o=l[e].split(" ")).shift().substr(8);for(t.c("group",{xmlns:"urn:xmpp:jingle:apps:grouping:0",semantics:u}),n=0;n<o.length;n++)t.c("content",{name:o[n]}).up();t.up()}for(SDPUtil.find_line(this.session,"a=group:BUNDLE")&&SDPUtil.find_line(this.session,"a=group:BUNDLE ").split(" ").shift(),e=0;e<this.media.length;e++)if("audio"==(s=SDPUtil.parse_mline(this.media[e].split("\r\n")[0])).media||"video"==s.media){if(a=!!SDPUtil.find_line(this.media[e],"a=ssrc:")&&SDPUtil.find_line(this.media[e],"a=ssrc:").substring(7).split(" ")[0],t.c("content",{creator:i,name:s.media}),SDPUtil.find_line(this.media[e],"a=mid:")){var d=SDPUtil.parse_mid(SDPUtil.find_line(this.media[e],"a=mid:"));t.attrs({name:d})}if(SDPUtil.find_line(this.media[e],"a=rtpmap:").length){for(t.c("description",{xmlns:"urn:xmpp:jingle:apps:rtp:1",media:s.media}),a&&t.attrs({ssrc:a}),n=0;n<s.fmt.length;n++){if(p=SDPUtil.find_line(this.media[e],"a=rtpmap:"+s.fmt[n]),t.c("payload-type",SDPUtil.parse_rtpmap(p)),SDPUtil.find_line(this.media[e],"a=fmtp:"+s.fmt[n]))for(o=SDPUtil.parse_fmtp(SDPUtil.find_line(this.media[e],"a=fmtp:"+s.fmt[n])),r=0;r<o.length;r++)t.c("parameter",o[r]).up();this.RtcpFbToJingle(e,t,s.fmt[n]),t.up()}if(SDPUtil.find_line(this.media[e],"a=crypto:",this.session))t.c("encryption",{required:1}),SDPUtil.find_lines(this.media[e],"a=crypto:",this.session).forEach(function(i){t.c("crypto",SDPUtil.parse_crypto(i)).up()}),t.up();if(a)t.c("source",{ssrc:a,xmlns:"urn:xmpp:jingle:apps:rtp:ssma:0"}),SDPUtil.find_lines(this.media[e],"a=ssrc:").forEach(function(i){idx=i.indexOf(" ");var e=i.substr(0,idx).substr(7);e!=a&&(t.up(),a=e,t.c("source",{ssrc:a,xmlns:"urn:xmpp:jingle:apps:rtp:ssma:0"}));var n=i.substr(idx+1);t.c("parameter"),-1==n.indexOf(":")?t.attrs({name:n}):(t.attrs({name:n.split(":",2)[0]}),t.attrs({value:n.split(":",2)[1]})),t.up()}),t.up();if(SDPUtil.find_line(this.media[e],"a=rtcp-mux")&&t.c("rtcp-mux").up(),this.RtcpFbToJingle(e,t,"*"),SDPUtil.find_line(this.media[e],"a=extmap:"))for(l=SDPUtil.find_lines(this.media[e],"a=extmap:"),n=0;n<l.length;n++){if(o=SDPUtil.parse_extmap(l[n]),t.c("rtp-hdrext",{xmlns:"urn:xmpp:jingle:apps:rtp:rtp-hdrext:0",uri:o.uri,id:o.value}),o.hasOwnProperty("direction"))switch(o.direction){case"sendonly":t.attrs({senders:"responder"});break;case"recvonly":t.attrs({senders:"initiator"});break;case"sendrecv":t.attrs({senders:"both"});break;case"inactive":t.attrs({senders:"none"})}t.up()}t.up()}this.TransportToJingle(e,t),SDPUtil.find_line(this.media[e],"a=sendrecv",this.session)?t.attrs({senders:"both"}):SDPUtil.find_line(this.media[e],"a=sendonly",this.session)?t.attrs({senders:"initiator"}):SDPUtil.find_line(this.media[e],"a=recvonly",this.session)?t.attrs({senders:"responder"}):SDPUtil.find_line(this.media[e],"a=inactive",this.session)&&t.attrs({senders:"none"}),"0"==s.port&&t.attrs({senders:"rejected"}),t.up()}return t.up(),t},SDP.prototype.TransportToJingle=function(t,i){var e,n=this;(i.c("transport"),SDPUtil.find_lines(this.media[t],"a=fingerprint:",this.session).forEach(function(r){(e=SDPUtil.parse_fingerprint(r)).xmlns="urn:xmpp:jingle:apps:dtls:0",i.c("fingerprint").t(e.fingerprint),delete e.fingerprint,(r=SDPUtil.find_line(n.media[t],"a=setup:",n.session))&&(e.setup=r.substr(8)),i.attrs(e),i.up()}),e=SDPUtil.iceparams(this.media[t],this.session))&&(e.xmlns="urn:xmpp:jingle:transports:ice-udp:1",i.attrs(e),SDPUtil.find_line(this.media[t],"a=candidate:",this.session)&&SDPUtil.find_lines(this.media[t],"a=candidate:",this.session).forEach(function(t){i.c("candidate",SDPUtil.candidateToJingle(t)).up()}));i.up()},SDP.prototype.RtcpFbToJingle=function(t,i,e){SDPUtil.find_lines(this.media[t],"a=rtcp-fb:"+e).forEach(function(t){var e=SDPUtil.parse_rtcpfb(t);"trr-int"==e.type?(i.c("rtcp-fb-trr-int",{xmlns:"urn:xmpp:jingle:apps:rtp:rtcp-fb:0",value:e.params[0]}),i.up()):(i.c("rtcp-fb",{xmlns:"urn:xmpp:jingle:apps:rtp:rtcp-fb:0",type:e.type}),e.params.length>0&&i.attrs({subtype:e.params[0]}),i.up())})},SDP.prototype.RtcpFbFromJingle=function(t,i){var e="",n=t.find('>rtcp-fb-trr-int[xmlns="urn:xmpp:jingle:apps:rtp:rtcp-fb:0"]');return n.length&&(e+="a=rtcp-fb:* trr-int ",n.attr("value")?e+=n.attr("value"):e+="0",e+="\r\n"),(n=t.find('>rtcp-fb[xmlns="urn:xmpp:jingle:apps:rtp:rtcp-fb:0"]')).each(function(){e+="a=rtcp-fb:"+i+" "+$(this).attr("type"),$(this).attr("subtype")&&(e+=" "+$(this).attr("subtype")),e+="\r\n"}),e},SDP.prototype.fromJingle=function(t){var i=this;if(this.raw="v=0\r\no=- 1923518516 2 IN IP4 0.0.0.0\r\ns=-\r\nt=0 0\r\n",$(t).find('>group[xmlns="urn:xmpp:jingle:apps:grouping:0"]').length)$(t).find('>group[xmlns="urn:xmpp:jingle:apps:grouping:0"]').each(function(t,e){var n=$(e).find(">content").map(function(t,i){return i.getAttribute("name")}).get();n.length>0&&(i.raw+="a=group:"+(e.getAttribute("semantics")||e.getAttribute("type"))+" "+n.join(" ")+"\r\n")});else if($(t).find('>group[xmlns="urn:ietf:rfc:5888"]').length)$(t).find('>group[xmlns="urn:ietf:rfc:5888"]').each(function(t,e){var n=$(e).find(">content").map(function(t,i){return i.getAttribute("name")}).get();null!==e.getAttribute("type")&&n.length>0&&(i.raw+="a=group:"+e.getAttribute("type")+" "+n.join(" ")+"\r\n")});else{var e=$(t).find(">content").filter(function(t,i){return $(i).find(">bundle").length>0}).map(function(t,i){return i.getAttribute("name")}).get();e.length&&(this.raw+="a=group:BUNDLE "+e.join(" ")+"\r\n")}this.session=this.raw,t.find(">content").each(function(){var t=i.jingle2media($(this));i.media.push(t)}),this.raw=this.session+this.media.join("")},SDP.prototype.jingle2media=function(t){var i,e="",n=t.find("description"),r=(n.attr("ssrc"),this);switch((i={media:n.attr("media")}).port="1","rejected"==t.attr("senders")&&(i.port="0"),t.find(">transport>fingerprint").length||n.find("encryption").length?i.proto="RTP/SAVPF":i.proto="RTP/AVPF",i.fmt=n.find("payload-type").map(function(){return this.getAttribute("id")}).get(),e+=SDPUtil.build_mline(i)+"\r\n",e+="c=IN IP4 0.0.0.0\r\n",e+="a=rtcp:1 IN IP4 0.0.0.0\r\n",(i=t.find('>transport[xmlns="urn:xmpp:jingle:transports:ice-udp:1"]')).length&&(i.attr("ufrag")&&(e+=SDPUtil.build_iceufrag(i.attr("ufrag"))+"\r\n"),i.attr("pwd")&&(e+=SDPUtil.build_icepwd(i.attr("pwd"))+"\r\n"),i.find(">fingerprint").each(function(){e+="a=fingerprint:"+this.getAttribute("hash"),e+=" "+$(this).text(),e+="\r\n",this.getAttribute("setup")&&(e+="a=setup:"+this.getAttribute("setup")+"\r\n")})),t.attr("senders")){case"initiator":e+="a=sendonly\r\n";break;case"responder":e+="a=recvonly\r\n";break;case"none":e+="a=inactive\r\n";break;case"both":e+="a=sendrecv\r\n"}return e+="a=mid:"+t.attr("name")+"\r\n",n.find("rtcp-mux").length&&(e+="a=rtcp-mux\r\n"),n.find("encryption").length&&n.find("encryption>crypto").each(function(){e+="a=crypto:"+this.getAttribute("tag"),e+=" "+this.getAttribute("crypto-suite"),e+=" "+this.getAttribute("key-params"),this.getAttribute("session-params")&&(e+=" "+this.getAttribute("session-params")),e+="\r\n"}),n.find("payload-type").each(function(){e+=SDPUtil.build_rtpmap(this)+"\r\n",$(this).find(">parameter").length&&(e+="a=fmtp:"+this.getAttribute("id")+" ",e+=$(this).find("parameter").map(function(){return(this.getAttribute("name")?this.getAttribute("name")+"=":"")+this.getAttribute("value")}).get().join(";"),e+="\r\n"),e+=r.RtcpFbFromJingle($(this),this.getAttribute("id"))}),e+=r.RtcpFbFromJingle(n,"*"),(i=n.find('>rtp-hdrext[xmlns="urn:xmpp:jingle:apps:rtp:rtp-hdrext:0"]')).each(function(){e+="a=extmap:"+this.getAttribute("id")+" "+this.getAttribute("uri")+"\r\n"}),t.find('>transport[xmlns="urn:xmpp:jingle:transports:ice-udp:1"]>candidate').each(function(){e+=SDPUtil.candidateFromJingle(this)}),(i=t.find('description>source[xmlns="urn:xmpp:jingle:apps:rtp:ssma:0"]')).each(function(){var t=this.getAttribute("ssrc");$(this).find(">parameter").each(function(){e+="a=ssrc:"+t+" "+this.getAttribute("name"),this.getAttribute("value")&&this.getAttribute("value").length&&(e+=":"+this.getAttribute("value")),e+="\r\n"})}),e},SDPUtil={iceparams:function(t,i){var e=null;return SDPUtil.find_line(t,"a=ice-ufrag:",i)&&SDPUtil.find_line(t,"a=ice-pwd:",i)&&(e={ufrag:SDPUtil.parse_iceufrag(SDPUtil.find_line(t,"a=ice-ufrag:",i)),pwd:SDPUtil.parse_icepwd(SDPUtil.find_line(t,"a=ice-pwd:",i))}),e},parse_iceufrag:function(t){return t.substring(12)},build_iceufrag:function(t){return"a=ice-ufrag:"+t},parse_icepwd:function(t){return t.substring(10)},build_icepwd:function(t){return"a=ice-pwd:"+t},parse_mid:function(t){return t.substring(6)},parse_mline:function(t){var i=t.substring(2).split(" "),e={};return e.media=i.shift(),e.port=i.shift(),e.proto=i.shift(),""===i[i.length-1]&&i.pop(),e.fmt=i,e},build_mline:function(t){return"m="+t.media+" "+t.port+" "+t.proto+" "+t.fmt.join(" ")},parse_rtpmap:function(t){var i=t.substring(9).split(" "),e={};return e.id=i.shift(),i=i[0].split("/"),e.name=i.shift(),e.clockrate=i.shift(),e.channels=i.length?i.shift():"1",e},build_rtpmap:function(t){var i="a=rtpmap:"+t.getAttribute("id")+" "+t.getAttribute("name")+"/"+t.getAttribute("clockrate");return t.getAttribute("channels")&&"1"!=t.getAttribute("channels")&&(i+="/"+t.getAttribute("channels")),i},parse_crypto:function(t){var i=t.substring(9).split(" "),e={};return e.tag=i.shift(),e["crypto-suite"]=i.shift(),e["key-params"]=i.shift(),i.length&&(e["session-params"]=i.join(" ")),e},parse_fingerprint:function(t){var i=t.substring(14).split(" "),e={};return e.hash=i.shift(),e.fingerprint=i.shift(),e},parse_fmtp:function(t){var i,e,n,r=t.split(" "),s=[];for(r.shift(),r=r.join(" ").split(";"),i=0;i<r.length;i++){for(e=r[i].split("=")[0];e.length&&" "==e[0];)e=e.substring(1);n=r[i].split("=")[1],e&&n?s.push({name:e,value:n}):e&&s.push({name:"",value:e})}return s},parse_icecandidate:function(t){var i={},e=t.split(" ");i.foundation=e[0].substring(12),i.component=e[1],i.protocol=e[2].toLowerCase(),i.priority=e[3],i.ip=e[4],i.port=e[5],i.type=e[7],i.generation=0;for(var n=8;n<e.length;n+=2)switch(e[n]){case"raddr":i["rel-addr"]=e[n+1];break;case"rport":i["rel-port"]=e[n+1];break;case"generation":i.generation=e[n+1];break;case"tcptype":"tcp"===i.protocol.toLowerCase()&&(i.tcptype=e[n+1]);break;default:console.log('parse_icecandidate not translating "'+e[n]+'" = "'+e[n+1]+'"')}return i.network="1",i.id=Math.random().toString(36).substr(2,10),i},build_icecandidate:function(t){var i=["a=candidate:"+t.foundation,t.component,t.protocol,t.priority,t.ip,t.port,"typ",t.type].join(" ");switch(i+=" ",t.type){case"srflx":case"prflx":case"relay":t.hasOwnAttribute("rel-addr")&&t.hasOwnAttribute("rel-port")&&(i+="raddr",i+=" ",i+=t["rel-addr"],i+=" ",i+="rport",i+=" ",i+=t["rel-port"],i+=" ")}return t.hasOwnAttribute("tcptype")&&(i+="tcptype",i+=" ",i+=t.tcptype,i+=" "),i+="generation",i+=" ",i+=t.hasOwnAttribute("generation")?t.generation:"0"},parse_ssrc:function(t){for(var i=t.split("\r\n"),e={},n=0;n<i.length;n++)if("a=ssrc:"==i[n].substring(0,7)){var r=i[n].indexOf(" ");e[i[n].substr(r+1).split(":",2)[0]]=i[n].substr(r+1).split(":",2)[1]}return e},parse_rtcpfb:function(t){var i=t.substr(10).split(" "),e={};return e.pt=i.shift(),e.type=i.shift(),e.params=i,e},parse_extmap:function(t){var i=t.substr(9).split(" "),e={};return e.value=i.shift(),-1!=e.value.indexOf("/")?(e.direction=e.value.substr(e.value.indexOf("/")+1),e.value=e.value.substr(0,e.value.indexOf("/"))):e.direction="both",e.uri=i.shift(),e.params=i,e},find_line:function(t,i,e){for(var n=t.split("\r\n"),r=0;r<n.length;r++)if(n[r].substring(0,i.length)==i)return n[r];if(!e)return!1;n=e.split("\r\n");for(var s=0;s<n.length;s++)if(n[s].substring(0,i.length)==i)return n[s];return!1},find_lines:function(t,i,e){for(var n=t.split("\r\n"),r=[],s=0;s<n.length;s++)n[s].substring(0,i.length)==i&&r.push(n[s]);if(r.length||!e)return r;n=e.split("\r\n");for(var a=0;a<n.length;a++)n[a].substring(0,i.length)==i&&r.push(n[a]);return r},candidateToJingle:function(t){if(0===t.indexOf("candidate:"))t="a="+t;else if("a=candidate:"!=t.substring(0,12))return console.log("parseCandidate called with a line that is not a candidate line"),console.log(t),null;"\r\n"==t.substring(t.length-2)&&(t=t.substring(0,t.length-2));var i,e={},n=t.split(" ");if("typ"!=n[6])return console.log("did not find typ in the right place"),console.log(t),null;for(e.foundation=n[0].substring(12),e.component=n[1],e.protocol=n[2].toLowerCase(),e.priority=n[3],e.ip=n[4],e.port=n[5],e.type=n[7],e.generation="0",i=8;i<n.length;i+=2)switch(n[i]){case"raddr":e["rel-addr"]=n[i+1];break;case"rport":e["rel-port"]=n[i+1];break;case"generation":e.generation=n[i+1];break;case"tcptype":e.tcptype=n[i+1];break;default:console.log('not translating "'+n[i]+'" = "'+n[i+1]+'"')}return e.network="1",e.id=Math.random().toString(36).substr(2,10),e},candidateFromJingle:function(t){var i=["a=candidate:"+t.getAttribute("foundation"),t.getAttribute("component"),t.getAttribute("protocol"),t.getAttribute("priority"),t.getAttribute("ip"),t.getAttribute("port"),"typ",t.getAttribute("type")];switch(t.getAttribute("type")){case"srflx":case"prflx":case"relay":t.getAttribute("rel-addr")&&t.getAttribute("rel-port")&&(i.push("raddr"),i.push(t.getAttribute("rel-addr")),i.push("rport"),i.push(t.getAttribute("rel-port")))}return i.push("generation"),i.push(t.getAttribute("generation")||"0"),i.join(" ")+"\r\n"}};