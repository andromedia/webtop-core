function TraceablePeerConnection(e,t){var n=this,a=navigator.mozGetUserMedia?mozRTCPeerConnection:webkitRTCPeerConnection;this.peerconnection=new a(e,t),this.updateLog=[],this.stats={},this.statsinterval=null,this.maxstats=300,this.trace=function(e,t){n.updateLog.push({time:new Date,type:e,value:t||""})},this.onicecandidate=null,this.peerconnection.onicecandidate=function(e){n.trace("onicecandidate",JSON.stringify(e.candidate,null," ")),null!==n.onicecandidate&&n.onicecandidate(e)},this.onaddstream=null,this.peerconnection.onaddstream=function(e){n.trace("onaddstream",e.stream.id),null!==n.onaddstream&&n.onaddstream(e)},this.onremovestream=null,this.peerconnection.onremovestream=function(e){n.trace("onremovestream",e.stream.id),null!==n.onremovestream&&n.onremovestream(e)},this.onsignalingstatechange=null,this.peerconnection.onsignalingstatechange=function(e){n.trace("onsignalingstatechange",n.signalingState),null!==n.onsignalingstatechange&&n.onsignalingstatechange(e)},this.oniceconnectionstatechange=null,this.peerconnection.oniceconnectionstatechange=function(e){n.trace("oniceconnectionstatechange",n.iceConnectionState),null!==n.oniceconnectionstatechange&&n.oniceconnectionstatechange(e)},this.onnegotiationneeded=null,this.peerconnection.onnegotiationneeded=function(e){n.trace("onnegotiationneeded"),null!==n.onnegotiationneeded&&n.onnegotiationneeded(e)},n.ondatachannel=null,this.peerconnection.ondatachannel=function(e){n.trace("ondatachannel",e),null!==n.ondatachannel&&n.ondatachannel(e)},navigator.mozGetUserMedia||(this.statsinterval=window.setInterval(function(){n.peerconnection.getStats(function(e){for(var t=e.result(),a=0;a<t.length;++a){var i=new Date;t[a].names().forEach(function(e){var o=t[a].id+"-"+e;n.stats[o]||(n.stats[o]={startTime:i,endTime:i,values:[],times:[]}),n.stats[o].values.push(t[a].stat(e)),n.stats[o].times.push(i.getTime()),n.stats[o].values.length>n.maxstats&&(n.stats[o].values.shift(),n.stats[o].times.shift()),n.stats[o].endTime=i})}})},1e3))}function setupRTC(){var e=null;navigator.mozGetUserMedia&&mozRTCPeerConnection?(console.log("This appears to be Firefox"),(navigator.userAgent.match(/Firefox/)?parseInt(navigator.userAgent.match(/Firefox\/([0-9]+)\./)[1],10):0)>=22&&(e={peerconnection:mozRTCPeerConnection,browser:"firefox",getUserMedia:navigator.mozGetUserMedia.bind(navigator),attachMediaStream:function(e,t){e[0].mozSrcObject=t,e[0].play()},pc_constraints:{}},RTCSessionDescription=mozRTCSessionDescription,RTCIceCandidate=mozRTCIceCandidate)):navigator.webkitGetUserMedia&&(console.log("This appears to be Chrome"),e={peerconnection:webkitRTCPeerConnection,browser:"chrome",getUserMedia:navigator.webkitGetUserMedia.bind(navigator),attachMediaStream:function(e,t){e.attr("src",webkitURL.createObjectURL(t))},pc_constraints:{optional:[{DtlsSrtpKeyAgreement:"true"}]}});if(null===e)try{console.log("Browser does not appear to be WebRTC-capable")}catch(e){}return e}function getUserMediaWithConstraints(e,t,n,a){var i={audio:!1,video:!1};switch(e.indexOf("video")>=0&&(i.video={mandatory:{}}),e.indexOf("audio")>=0&&(i.audio={}),e.indexOf("screen")>=0&&(i.video={mandatory:{chromeMediaSource:"screen"}}),t&&!i.video&&(i.video={mandatory:{}}),t){case"1080":case"fullhd":i.video.mandatory.minWidth=1920,i.video.mandatory.minHeight=1080;break;case"720":case"hd":i.video.mandatory.minWidth=1280,i.video.mandatory.minHeight=720;break;case"360":i.video.mandatory.minWidth=640,i.video.mandatory.minHeight=360;break;case"180":i.video.mandatory.minWidth=320,i.video.mandatory.minHeight=180;break;case"960":i.video.mandatory.minWidth=960,i.video.mandatory.minHeight=720;break;case"640":case"vga":i.video.mandatory.minWidth=640,i.video.mandatory.minHeight=480;break;case"320":i.video.mandatory.minWidth=320,i.video.mandatory.minHeight=240;break;default:-1!=navigator.userAgent.indexOf("Android")&&(i.video.mandatory.minWidth=320,i.video.mandatory.minHeight=240,i.video.mandatory.maxFrameRate=15)}i.video.minWidth&&(i.video.maxWidth=i.video.minWidth),i.video.minHeight&&(i.video.maxHeight=i.video.minHeight),n&&(i.video||(i.video={mandatory:{}}),i.video.optional=[{bandwidth:n}]),a&&(i.video||(i.video={mandatory:{}}),i.video.mandatory.minFrameRate=a);try{RTC.getUserMedia(i,function(e){console.log("onUserMediaSuccess"),$(document).trigger("mediaready.jingle",[e])},function(e){console.warn("Failed to get access to local media. Error ",e),$(document).trigger("mediafailure.jingle")})}catch(e){console.error("GUM failed: ",e),$(document).trigger("mediafailure.jingle")}}dumpSDP=function(e){return"type: "+e.type+"\r\n"+e.sdp},["signalingState","iceConnectionState","localDescription","remoteDescription"].forEach(function(e){Object.defineProperty(TraceablePeerConnection.prototype,e,{get:function(){return this.peerconnection[e]}})}),TraceablePeerConnection.prototype.addStream=function(e){this.trace("addStream",e.id),this.peerconnection.addStream(e)},TraceablePeerConnection.prototype.removeStream=function(e){this.trace("removeStream",e.id),this.peerconnection.removeStream(e)},TraceablePeerConnection.prototype.createDataChannel=function(e,t){this.trace("createDataChannel",e,t),this.peerconnection.createDataChannel(e,t)},TraceablePeerConnection.prototype.setLocalDescription=function(e,t,n){var a=this;this.trace("setLocalDescription",dumpSDP(e)),this.peerconnection.setLocalDescription(e,function(){a.trace("setLocalDescriptionOnSuccess"),t()},function(e){a.trace("setLocalDescriptionOnFailure",e),n(e)})},TraceablePeerConnection.prototype.setRemoteDescription=function(e,t,n){var a=this;this.trace("setRemoteDescription",dumpSDP(e)),this.peerconnection.setRemoteDescription(e,function(){a.trace("setRemoteDescriptionOnSuccess"),t()},function(e){a.trace("setRemoteDescriptionOnFailure",e),n(e)})},TraceablePeerConnection.prototype.close=function(){this.trace("stop"),null!==this.statsinterval&&(window.clearInterval(this.statsinterval),this.statsinterval=null),this.peerconnection.close()},TraceablePeerConnection.prototype.createOffer=function(e,t,n){var a=this;this.trace("createOffer",JSON.stringify(n,null," ")),this.peerconnection.createOffer(function(t){a.trace("createOfferOnSuccess",dumpSDP(t)),e(t)},function(e){a.trace("createOfferOnFailure",e),t(e)},n)},TraceablePeerConnection.prototype.createAnswer=function(e,t,n){var a=this;this.trace("createAnswer",JSON.stringify(n,null," ")),this.peerconnection.createAnswer(function(t){a.trace("createAnswerOnSuccess",dumpSDP(t)),e(t)},function(e){a.trace("createAnswerOnFailure",e),t(e)},n)},TraceablePeerConnection.prototype.addIceCandidate=function(e,t,n){var a=this;this.trace("addIceCandidate",JSON.stringify(e,null," ")),this.peerconnection.addIceCandidate(e),this.peerconnection.addIceCandidate(e,function(){a.trace("addIceCandidateOnSuccess"),t&&t()},function(e){a.trace("addIceCandidateOnFailure",e),n&&n(e)})},TraceablePeerConnection.prototype.getStats=function(e){navigator.mozGetUserMedia||this.peerconnection.getStats(e)};