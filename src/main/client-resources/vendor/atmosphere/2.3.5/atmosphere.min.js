!function(e,n){"function"==typeof define&&define.amd?define(n):"undefined"!=typeof exports?module.exports=n():e.atmosphere=n()}(this,function(){"use strict";var e={},n=!1,t=[],o=[],r=0,a=Object.prototype.hasOwnProperty;return e={version:"2.3.5-javascript",onError:function(e){},onClose:function(e){},onOpen:function(e){},onReopen:function(e){},onMessage:function(e){},onReconnect:function(e,n){},onMessagePublished:function(e){},onTransportFailure:function(e,n){},onLocalMessage:function(e){},onFailureToReconnect:function(e,n){},onClientTimeout:function(e){},onOpenAfterResume:function(e){},WebsocketApiAdapter:function(n){var t,o;return n.onMessage=function(e){o.onmessage({data:e.responseBody})},n.onMessagePublished=function(e){o.onmessage({data:e.responseBody})},n.onOpen=function(e){o.onopen(e)},o={close:function(){t.close()},send:function(e){t.push(e)},onmessage:function(e){},onopen:function(e){},onclose:function(e){},onerror:function(e){}},t=new e.subscribe(n),o},AtmosphereRequest:function(t){function a(){we=!0,Se=!1,ye=0,ge=null,me=null,he=null,be=null}function i(){f(),a()}function s(e){return"debug"==e?"debug"===fe.logLevel:"info"==e?"info"===fe.logLevel||"debug"===fe.logLevel:"warn"==e?"warn"===fe.logLevel||"info"===fe.logLevel||"debug"===fe.logLevel:"error"==e&&("error"===fe.logLevel||"warn"===fe.logLevel||"info"===fe.logLevel||"debug"===fe.logLevel)}function l(n){s("debug")&&e.util.debug(new Date+" Atmosphere: "+n)}function c(e,n){return""===pe.partialMessage&&"streaming"===n.transport&&e.responseText.length>n.maxStreamingLength}function u(){if(fe.enableProtocol&&!fe.disableDisconnect&&!fe.firstMessage){var n="X-Atmosphere-Transport=close&X-Atmosphere-tracking-id="+fe.uuid;e.util.each(fe.headers,function(t,o){var r=e.util.isFunction(o)?o.call(this,fe,fe,pe):o;null!=r&&(n+="&"+encodeURIComponent(t)+"="+encodeURIComponent(r))});var t=fe.url.replace(/([?&])_=[^&]*/,n);t+=t===fe.url?(/\?/.test(fe.url)?"&":"?")+n:"";var o={connected:!1},r=new e.AtmosphereRequest(o);r.connectTimeout=fe.connectTimeout,r.attachHeadersAsQueryString=!1,r.dropHeaders=!0,r.url=t,r.contentType="text/plain",r.transport="polling",r.method="GET",r.data="",r.heartbeat=null,fe.enableXDR&&(r.enableXDR=fe.enableXDR),r.async=fe.closeAsync,z("",r)}}function d(){l("Closing (AtmosphereRequest._close() called)"),Se=!0,fe.reconnectId&&(clearTimeout(fe.reconnectId),delete fe.reconnectId),fe.heartbeatTimer&&clearTimeout(fe.heartbeatTimer),fe.reconnect=!1,pe.request=fe,pe.state="unsubscribe",pe.responseBody="",pe.status=408,pe.partialMessage="",fe.curWebsocketErrorRetries=0,le(),u(),f()}function f(){pe.partialMessage="",fe.id&&clearTimeout(fe.id),fe.heartbeatTimer&&clearTimeout(fe.heartbeatTimer),fe.reconnectId&&(clearTimeout(fe.reconnectId),delete fe.reconnectId),null!=be&&(be.close(),be=null),null!=ve&&(ve.abort(),ve=null),null!=he&&(he.abort(),he=null),null!=ge&&(ge.canSendMessage&&(l("invoking .close() on WebSocket object"),ge.close()),ge=null),null!=me&&(me.close(),me=null),p()}function p(){null!=ce&&(clearInterval(ue),document.cookie=de+"=; expires=Thu, 01 Jan 1970 00:00:00 GMT; path=/",ce.signal("close",{reason:"",heir:Se?(ce.get("children")||[])[0]:xe}),ce.close()),null!=Ce&&Ce.close()}function g(n){i(),(fe=e.util.extend(fe,n)).mrequest=fe.reconnect,fe.reconnect||(fe.reconnect=!0)}function m(){return null!=fe.webSocketImpl||window.WebSocket||window.MozWebSocket}function h(){var n=e.util.getAbsoluteURL(fe.url.toLowerCase()),t=/^([\w\+\.\-]+:)(?:\/\/([^\/?#:]*)(?::(\d+))?)?/.exec(n),o=!(!t||t[1]==window.location.protocol&&t[2]==window.location.hostname&&(t[3]||("http:"===t[1]?80:443))==(window.location.port||("http:"===window.location.protocol?80:443)));return window.EventSource&&(!o||!e.util.browser.safari||e.util.browser.vmajor>=7)}function b(){if(fe.shared){if(null!=(Ce=v(fe))&&(s("debug")&&e.util.debug("Storage service available. All communication will be local"),Ce.open(fe)))return;s("debug")&&e.util.debug("No Storage service available."),Ce=null}fe.firstMessage=0==r,fe.isOpen=!1,fe.ctime=e.util.now(),0===fe.uuid&&(fe.uuid=r),pe.closedByClientTimeout=!1,"websocket"!==fe.transport&&"sse"!==fe.transport?q(fe):"websocket"===fe.transport?m()?x(!1):B("Websocket is not supported, using request.fallbackTransport ("+fe.fallbackTransport+")"):"sse"===fe.transport&&(h()?C(!1):B("Server Side Events(SSE) is not supported, using request.fallbackTransport ("+fe.fallbackTransport+")"))}function v(n){function t(e,n){var t,o=e.length;for(t=0;t<o;t++)e[t]===n&&e.splice(t,1);return o!==e.length}function o(t){var o=e.util.parseJSON(t),r=o.data;if("c"===o.target)switch(o.type){case"open":y("opening","local",fe);break;case"close":s||(s=!0,"aborted"===r.reason?d():r.heir===xe?b():setTimeout(function(){b()},100));break;case"message":oe(r,"messageReceived",200,n.transport);break;case"localMessage":te(r)}}function r(){var n=new RegExp("(?:^|; )("+encodeURIComponent(l)+")=([^;]*)").exec(document.cookie);if(n)return e.util.parseJSON(decodeURIComponent(n[2]))}var a,i,s,l="atmosphere-"+n.url,c={storage:function(){function r(e){e.key===l&&e.newValue&&o(e.newValue)}if(e.util.storage){var a=window.localStorage,i=function(n){var t=a.getItem(l+"-"+n);return null===t?[]:e.util.parseJSON(t)},s=function(n,t){a.setItem(l+"-"+n,e.util.stringifyJSON(t))};return{init:function(){return s("children",i("children").concat([xe])),e.util.on(window,"storage",r),i("opened")},signal:function(n,t){a.setItem(l,e.util.stringifyJSON({target:"p",type:n,data:t}))},close:function(){var o=i("children");e.util.off(window,"storage",r),o&&t(o,n.id)&&s("children",o)}}}},windowref:function(){var n=window.open("",l.replace(/\W/g,""));if(n&&!n.closed&&n.callbacks)return{init:function(){return n.callbacks.push(o),n.children.push(xe),n.opened},signal:function(t,o){!n.closed&&n.fire&&n.fire(e.util.stringifyJSON({target:"p",type:t,data:o}))},close:function(){s||(t(n.callbacks,o),t(n.children,xe))}}}};if((a=r())&&!(e.util.now()-a.ts>1e3)&&(i=c.storage()||c.windowref()))return{open:function(){var t;return ue=setInterval(function(){var n=a;(a=r())&&n.ts!==a.ts||o(e.util.stringifyJSON({target:"c",type:"close",data:{reason:"error",heir:n.heir}}))},1e3),(t=i.init())&&setTimeout(function(){y("opening","local",n)},50),t},send:function(e){i.signal("send",e)},localSend:function(n){i.signal("localSend",e.util.stringifyJSON({id:xe,event:n}))},close:function(){Se||(clearInterval(ue),i.signal("close"),i.close())}}}function w(){function n(n){var t=e.util.parseJSON(n),o=t.data;if("p"===t.target)switch(t.type){case"send":$(o);break;case"localSend":te(o);break;case"close":d()}}function t(){document.cookie=de+"="+encodeURIComponent(e.util.stringifyJSON({ts:e.util.now()+1,heir:(o.get("children")||[])[0]}))+"; path=/"}var o,r="atmosphere-"+fe.url,a={storage:function(){function t(e){e.key===r&&e.newValue&&n(e.newValue)}if(e.util.storage){var o=window.localStorage;return{init:function(){e.util.on(window,"storage",t)},signal:function(n,t){o.setItem(r,e.util.stringifyJSON({target:"c",type:n,data:t}))},get:function(n){return e.util.parseJSON(o.getItem(r+"-"+n))},set:function(n,t){o.setItem(r+"-"+n,e.util.stringifyJSON(t))},close:function(){e.util.off(window,"storage",t),o.removeItem(r),o.removeItem(r+"-opened"),o.removeItem(r+"-children")}}}},windowref:function(){var t,o=r.replace(/\W/g,""),a=document.getElementById(o);return a||((a=document.createElement("div")).id=o,a.style.display="none",a.innerHTML='<iframe name="'+o+'" />',document.body.appendChild(a)),t=a.firstChild.contentWindow,{init:function(){t.callbacks=[n],t.fire=function(e){var n;for(n=0;n<t.callbacks.length;n++)t.callbacks[n](e)}},signal:function(n,o){!t.closed&&t.fire&&t.fire(e.util.stringifyJSON({target:"c",type:n,data:o}))},get:function(e){return t.closed?null:t[e]},set:function(e,n){t.closed||(t[e]=n)},close:function(){}}}};Re=function(e){o.signal("message",e)},(o=a.storage()||a.windowref()).init(),s("debug")&&e.util.debug("Installed StorageService "+o),o.set("children",[]),null==o.get("opened")||o.get("opened")||o.set("opened",!1),de=encodeURIComponent(r),t(),ue=setInterval(t,1e3),ce=o}function y(e,n,t){if(fe.shared&&"local"!==n&&w(),null!=ce&&ce.set("opened",!0),t.close=function(){d()},ye>0&&"re-connecting"===e)t.isReopen=!0,H(pe);else if(null==pe.error){pe.request=t;var o=pe.state;pe.state=e;var r=pe.transport;pe.transport=n;var a=pe.responseBody;le(),pe.responseBody=a,pe.state=o,pe.transport=r}}function T(n){n.transport="jsonp";var t,o=fe;null!=n&&void 0!==n&&(o=n),(ve={open:function(){function r(){o.lastIndex=0,o.openId&&clearTimeout(o.openId),o.heartbeatTimer&&clearTimeout(o.heartbeatTimer),o.reconnect&&ye++<o.maxReconnectOnClose?(y("re-connecting",o.transport,o),j(ve,o,n.reconnectInterval),o.openId=setTimeout(function(){E(o)},o.reconnectInterval+1e3)):L(0,"maxReconnectOnClose reached")}function a(){var e=o.url;null!=o.dispatchUrl&&(e+=o.dispatchUrl);var a=o.data;o.attachHeadersAsQueryString&&(e=M(o),""!==a&&(e+="&X-Atmosphere-Post-Body="+encodeURIComponent(a)),a="");var s=document.head||document.getElementsByTagName("head")[0]||document.documentElement;(t=document.createElement("script")).src=e+"&jsonpTransport="+i,t.clean=function(){t.clean=t.onerror=t.onload=t.onreadystatechange=null,t.parentNode&&t.parentNode.removeChild(t),2==++n.scriptCount&&(n.scriptCount=1,r())},t.onload=t.onreadystatechange=function(){l("jsonp.onload"),t.readyState&&!/loaded|complete/.test(t.readyState)||t.clean()},t.onerror=function(){l("jsonp.onerror"),n.scriptCount=1,t.clean()},s.insertBefore(t,s.firstChild)}var i="atmosphere"+ ++xe;window[i]=function(t){if(l("jsonp.window"),n.scriptCount=0,o.reconnect&&-1===o.maxRequest||o.requestCount++<o.maxRequest){if(o.executeCallbackBeforeReconnect||j(ve,o,o.pollingInterval),null!=t&&"string"!=typeof t)try{t=t.message}catch(e){}U(t,o,pe)||oe(pe.responseBody,"messageReceived",200,o.transport),o.executeCallbackBeforeReconnect&&j(ve,o,o.pollingInterval),O(o)}else e.util.log(fe.logLevel,["JSONP reconnect maximum try reached "+fe.requestCount]),L(0,"maxRequest reached")},setTimeout(function(){a()},50)},abort:function(){t&&t.clean&&t.clean()}}).open()}function k(e){return null!=fe.webSocketImpl?fe.webSocketImpl:window.WebSocket?new WebSocket(e):new MozWebSocket(e)}function S(){return M(fe,e.util.getAbsoluteURL(fe.webSocketUrl||fe.url)).replace(/^http/,"ws")}function R(){return M(fe)}function C(n){pe.transport="sse";var t=R();if(s("debug")&&(e.util.debug("Invoking executeSSE"),e.util.debug("Using URL: "+t)),!n||fe.reconnect){try{me=new EventSource(t,{withCredentials:fe.withCredentials})}catch(e){return L(0,e),void B("SSE failed. Downgrading to fallback transport and resending")}fe.connectTimeout>0&&(fe.id=setTimeout(function(){n||f()},fe.connectTimeout)),me.onopen=function(t){l("sse.onopen"),O(fe),s("debug")&&e.util.debug("SSE successfully opened"),fe.enableProtocol?fe.isReopen&&(fe.isReopen=!1,y("re-opening",fe.transport,fe)):n?y("re-opening","sse",fe):y("opening","sse",fe),n=!0,"POST"===fe.method&&(pe.state="messageReceived",me.send(fe.data))},me.onmessage=function(n){l("sse.onmessage"),O(fe),!fe.enableXDR&&window.location.host&&n.origin&&n.origin!==window.location.protocol+"//"+window.location.host?e.util.log(fe.logLevel,["Origin was not "+window.location.protocol+"//"+window.location.host]):(pe.state="messageReceived",pe.status=200,U(n=n.data,fe,pe)||(le(),pe.responseBody="",pe.messages=[]))},me.onerror=function(t){l("sse.onerror"),clearTimeout(fe.id),fe.heartbeatTimer&&clearTimeout(fe.heartbeatTimer),pe.closedByClientTimeout||(se(n),f(),Se?e.util.log(fe.logLevel,["SSE closed normally"]):n?fe.reconnect&&"sse"===pe.transport&&(ye++<fe.maxReconnectOnClose?(y("re-connecting",fe.transport,fe),fe.reconnectInterval>0?fe.reconnectId=setTimeout(function(){C(!0)},fe.reconnectInterval):C(!0),pe.responseBody="",pe.messages=[]):(e.util.log(fe.logLevel,["SSE reconnect maximum try reached "+ye]),L(0,"maxReconnectOnClose reached"))):B("SSE failed. Downgrading to fallback transport and resending"))}}else null!=me&&f()}function x(t){pe.transport="websocket";var o=S(fe.url);s("debug")&&e.util.debug("Invoking executeWebSocket, using URL: "+o),!t||fe.reconnect?(ge=k(o),null!=fe.webSocketBinaryType&&(ge.binaryType=fe.webSocketBinaryType),fe.connectTimeout>0&&(fe.id=setTimeout(function(){if(t);else{var e={code:1002,reason:"",wasClean:!1};ge.onclose(e);try{f()}catch(e){}}},fe.connectTimeout)),ge.onopen=function(o){l("websocket.onopen"),O(fe),n=!1,s("debug")&&e.util.debug("Websocket successfully opened");var r=t;null!=ge&&(ge.canSendMessage=!0),fe.enableProtocol||(t=!0,r?y("re-opening","websocket",fe):y("opening","websocket",fe)),null!=ge&&"POST"===fe.method&&(pe.state="messageReceived",ge.send(fe.data))},ge.onmessage=function(e){if(l("websocket.onmessage"),O(fe),fe.enableProtocol&&(t=!0),pe.state="messageReceived",pe.status=200,"string"==typeof(e=e.data))U(e,fe,pe)||(le(),pe.responseBody="",pe.messages=[]);else{if(""===(e=I(fe,e)))return;pe.responseBody=e,le(),pe.responseBody=null}},ge.onerror=function(e){l("websocket.onerror"),clearTimeout(fe.id),fe.heartbeatTimer&&clearTimeout(fe.heartbeatTimer),++fe.curWebsocketErrorRetries<fe.maxWebsocketErrorRetries&&"websocket"!==fe.fallbackTransport&&B("Failed to connect via Websocket. Downgrading to "+fe.fallbackTransport+" and resending")},ge.onclose=function(o){if(l("websocket.onclose"),clearTimeout(fe.id),"closed"!==pe.state){var r=o.reason;if(""===r)switch(o.code){case 1e3:r="Normal closure; the connection successfully completed whatever purpose for which it was created.";break;case 1001:r="The endpoint is going away, either because of a server failure or because the browser is navigating away from the page that opened the connection.";break;case 1002:r="The endpoint is terminating the connection due to a protocol error.";break;case 1003:r="The connection is being terminated because the endpoint received data of a type it cannot accept (for example, a text-only endpoint received binary data).";break;case 1004:r="The endpoint is terminating the connection because a data frame was received that is too large.";break;case 1005:r="Unknown: no status code was provided even though one was expected.";break;case 1006:r="Connection was closed abnormally (that is, with no close frame being sent)."}s("warn")&&e.util.warn("Websocket closed, reason: "+r+" - wasClean: "+o.wasClean),pe.closedByClientTimeout||fe.handleOnlineOffline&&n?fe.reconnectId&&(clearTimeout(fe.reconnectId),delete fe.reconnectId):(se(t),pe.state="closed",Se?e.util.log(fe.logLevel,["Websocket closed normally"]):t||"websocket"===fe.fallbackTransport?fe.reconnect&&"websocket"===pe.transport&&(f(),ye++<fe.maxReconnectOnClose?(y("re-connecting",fe.transport,fe),fe.reconnectInterval>0?fe.reconnectId=setTimeout(function(){pe.responseBody="",pe.messages=[],x(!0)},fe.reconnectInterval):(pe.responseBody="",pe.messages=[],x(!0))):(e.util.log(fe.logLevel,["Websocket reconnect maximum try reached "+ye]),s("warn")&&e.util.warn("Websocket error, reason: "+o.reason),L(0,"maxReconnectOnClose reached"))):B("Websocket failed on first connection attempt. Downgrading to "+fe.fallbackTransport+" and resending"))}},navigator.userAgent.toLowerCase().indexOf("android")>-1&&void 0===ge.url&&ge.onclose({reason:"Android 4.1 does not support websockets.",wasClean:!1})):null!=ge&&f()}function I(n,t){var o=t;if("polling"===n.transport)return o;if(n.enableProtocol&&n.firstMessage&&0!==e.util.trim(t).length){var a=n.trackMessageLength?1:0,i=t.split(n.messageDelimiter);if(i.length<=a+1)return o;if(n.firstMessage=!1,n.uuid=e.util.trim(i[a]),i.length<=a+2&&e.util.log("error",["Protocol data not sent by the server. If you enable protocol on client side, be sure to install JavascriptProtocol interceptor on server side.Also note that atmosphere-runtime 2.2+ should be used."]),Te=parseInt(e.util.trim(i[a+1]),10),ke=i[a+2],"long-polling"!==n.transport&&E(n),r=n.uuid,o="",a=n.trackMessageLength?4:3,i.length>a+1)for(var s=a;s<i.length;s++)o+=i[s],s+1!==i.length&&(o+=n.messageDelimiter);0!==n.ackInterval&&setTimeout(function(){$("...ACK...")},n.ackInterval)}else n.enableProtocol&&n.firstMessage&&e.util.browser.msie&&+e.util.browser.version.split(".")[0]<10?e.util.log(fe.logLevel,["Receiving unexpected data from IE"]):E(n);return o}function O(e){clearTimeout(e.id),e.timeout>0&&"polling"!==e.transport&&(e.id=setTimeout(function(){A(e),u(),f()},e.timeout))}function A(e){pe.closedByClientTimeout=!0,pe.state="closedByClient",pe.responseBody="",pe.status=408,pe.messages=[],le()}function L(e,n){f(),clearTimeout(fe.id),pe.state="error",pe.reasonPhrase=n,pe.responseBody="",pe.status=e,pe.messages=[],le()}function U(e,n,t){if(0===(e=I(n,e)).length)return!0;if(t.responseBody=e,n.trackMessageLength){var o=[],r=(e=t.partialMessage+e).indexOf(n.messageDelimiter);if(-1!=r){for(;-1!==r;){var a=e.substring(0,r),i=+a;if(isNaN(i))throw t.partialMessage="",new Error('message length "'+a+'" is not a number');(r+=n.messageDelimiter.length)+i>e.length?r=-1:(o.push(e.substring(r,r+i)),r=(e=e.substring(r+i,e.length)).indexOf(n.messageDelimiter))}return t.partialMessage=e,0!==o.length?(t.responseBody=o.join(n.messageDelimiter),t.messages=o,!1):(t.responseBody="",t.messages=[],!0)}}return t.responseBody=e,t.messages=[e],!1}function B(n){e.util.log(fe.logLevel,[n]),void 0!==fe.onTransportFailure?fe.onTransportFailure(n,fe):void 0!==e.util.onTransportFailure&&e.util.onTransportFailure(n,fe);var t=-1===fe.connectTimeout?0:fe.connectTimeout;fe.reconnect&&"none"!==fe.transport||null==fe.transport?(fe.transport=fe.fallbackTransport,fe.method=fe.fallbackMethod,pe.transport=fe.fallbackTransport,pe.state="",fe.fallbackTransport="none",t>0?fe.reconnectId=setTimeout(function(){b()},t):b()):L(500,"Unable to reconnect with fallback transport")}function M(n,t){var o=fe;return null!=n&&void 0!==n&&(o=n),null==t&&(t=o.url),o.attachHeadersAsQueryString?-1!==t.indexOf("X-Atmosphere-Framework")?t:(t+=-1!==t.indexOf("?")?"&":"?",t+="X-Atmosphere-tracking-id="+o.uuid,t+="&X-Atmosphere-Framework="+e.version,t+="&X-Atmosphere-Transport="+o.transport,o.trackMessageLength&&(t+="&X-Atmosphere-TrackMessageSize=true"),null!==o.heartbeat&&null!==o.heartbeat.server&&(t+="&X-Heartbeat-Server="+o.heartbeat.server),""!==o.contentType&&(t+="&Content-Type="+("websocket"===o.transport?o.contentType:encodeURIComponent(o.contentType))),o.enableProtocol&&(t+="&X-atmo-protocol=true"),e.util.each(o.headers,function(r,a){var i=e.util.isFunction(a)?a.call(this,o,n,pe):a;null!=i&&(t+="&"+encodeURIComponent(r)+"="+encodeURIComponent(i))}),t):t}function E(e){if(e.isOpen)if(e.isReopen)e.isReopen=!1,y("re-opening",e.transport,e);else{if("messageReceived"!==pe.state||"jsonp"!==e.transport&&"long-polling"!==e.transport)return;X(pe)}else e.isOpen=!0,y("opening",e.transport,e);D(e)}function D(n){if(null!=n.heartbeatTimer&&clearTimeout(n.heartbeatTimer),!isNaN(Te)&&Te>0){var t=function(){s("debug")&&e.util.debug("Sending heartbeat"),$(ke),n.heartbeatTimer=setTimeout(t,Te)};n.heartbeatTimer=setTimeout(t,Te)}}function q(n){var t=fe;if(null==n&&void 0===n||(t=n),t.lastIndex=0,t.readyState=0,"jsonp"===t.transport||t.enableXDR&&e.util.checkCORSSupport())T(t);else{if(e.util.browser.msie&&+e.util.browser.version.split(".")[0]<10){if("streaming"===t.transport)return void(t.enableXDR&&window.XDomainRequest?F(t):W(t));if(t.enableXDR&&window.XDomainRequest)return void F(t)}var o=function(e){if(t.lastIndex=0,ye++,e||t.reconnect&&ye<=t.maxReconnectOnClose){var o=e?0:n.reconnectInterval;pe.ffTryingReconnect=!0,y("re-connecting",n.transport,n),j(i,t,o)}else L(0,"maxReconnectOnClose reached")},r=function(n){e._beforeUnloadState?(e.util.debug(new Date+" Atmosphere: reconnectF: execution delayed due to _beforeUnloadState flag"),setTimeout(function(){o(n)},5e3)):o(n)},a=function(){pe.errorHandled=!0,f(),r(!1)};if(t.force||t.reconnect&&(-1===t.maxRequest||t.requestCount++<t.maxRequest)){t.force=!1;var i=e.util.xhr();i.hasData=!1,N(i,t,!0),t.suspend&&(he=i),"polling"!==t.transport&&(pe.transport=t.transport,i.onabort=function(){l("ajaxrequest.onabort"),se(!0)},i.onerror=function(){l("ajaxrequest.onerror"),pe.error=!0,pe.ffTryingReconnect=!0;try{pe.status=XMLHttpRequest.status}catch(e){pe.status=500}pe.status||(pe.status=500),pe.errorHandled||(f(),r(!1))}),i.onreadystatechange=function(){if(l("ajaxRequest.onreadystatechange, new state: "+i.readyState),Se)l("onreadystatechange has been ignored due to _abortingConnection flag");else{pe.error=null;var o=!1,s=!1;if("streaming"===t.transport&&t.readyState>2&&4===i.readyState)return f(),void r(!1);if(t.readyState=i.readyState,"streaming"===t.transport&&i.readyState>=3?s=!0:"long-polling"===t.transport&&4===i.readyState&&(s=!0),O(fe),"polling"!==t.transport){var u=200;if(4===i.readyState&&(u=i.status>1e3?0:i.status),!t.reconnectOnServerError&&u>=300&&u<600)return void L(u,i.statusText);if(u>=300||0===u)return void a();t.enableProtocol&&n.firstMessage||2!==i.readyState||(e.util.browser.mozilla&&pe.ffTryingReconnect?(pe.ffTryingReconnect=!1,setTimeout(function(){pe.ffTryingReconnect||E(t)},500)):E(t))}else 4===i.readyState&&(s=!0);if(s){var d=i.responseText;if(pe.errorHandled=!1,"long-polling"===t.transport&&0===e.util.trim(d).length)return void(i.hasData?i.hasData=!1:r(!0));if(i.hasData=!0,re(i,fe),"streaming"===t.transport)if(e.util.browser.opera)e.util.iterate(function(){if(500!==pe.status&&i.responseText.length>t.lastIndex){try{pe.status=i.status,pe.headers=e.util.parseHeaders(i.getAllResponseHeaders()),re(i,fe)}catch(e){pe.status=404}O(fe),pe.state="messageReceived";var n=i.responseText.substring(t.lastIndex);if(t.lastIndex=i.responseText.length,(o=U(n,t,pe))||le(),c(i,t))return void P(i,t)}else if(pe.status>400)return t.lastIndex=i.responseText.length,!1},0);else{var p=d.substring(t.lastIndex,d.length);if(o=U(p,t,pe),t.lastIndex=d.length,o)return}else o=U(d,t,pe);var g=c(i,t);try{pe.status=i.status,pe.headers=e.util.parseHeaders(i.getAllResponseHeaders()),re(i,t)}catch(e){pe.status=404}t.suspend?pe.state=0===pe.status?"closed":"messageReceived":pe.state="messagePublished";var m=!g&&"streaming"!==n.transport&&"polling"!==n.transport;m&&!t.executeCallbackBeforeReconnect&&j(i,t,t.pollingInterval),0===pe.responseBody.length||o||le(),m&&t.executeCallbackBeforeReconnect&&j(i,t,t.pollingInterval),g&&P(i,t)}}};try{i.send(t.data),we=!0}catch(n){e.util.log(t.logLevel,["Unable to connect to "+t.url]),L(0,n)}}else"debug"===t.logLevel&&e.util.log(t.logLevel,["Max re-connection reached."]),L(0,"maxRequest reached")}}function P(e,n){pe.messages=[],n.isReopen=!0,d(),Se=!1,j(e,n,500)}function N(n,t,o){var r=t.url;null!=t.dispatchUrl&&"POST"===t.method&&(r+=t.dispatchUrl),r=M(t,r),r=e.util.prepareURL(r),o&&(n.open(t.method,r,t.async),t.connectTimeout>0&&(t.id=setTimeout(function(){0===t.requestCount&&(f(),oe("Connect timeout","closed",200,t.transport))},t.connectTimeout))),fe.withCredentials&&"websocket"!==fe.transport&&"withCredentials"in n&&(n.withCredentials=!0),fe.dropHeaders||(n.setRequestHeader("X-Atmosphere-Framework",e.version),n.setRequestHeader("X-Atmosphere-Transport",t.transport),null!==t.heartbeat&&null!==t.heartbeat.server&&n.setRequestHeader("X-Heartbeat-Server",n.heartbeat.server),t.trackMessageLength&&n.setRequestHeader("X-Atmosphere-TrackMessageSize","true"),n.setRequestHeader("X-Atmosphere-tracking-id",t.uuid),e.util.each(t.headers,function(r,a){var i=e.util.isFunction(a)?a.call(this,n,t,o,pe):a;null!=i&&n.setRequestHeader(r,i)})),""!==t.contentType&&n.setRequestHeader("Content-Type",t.contentType)}function j(e,n,t){if(!pe.closedByClientTimeout&&(n.reconnect||n.suspend&&we)){var o=0;e&&e.readyState>1&&(o=e.status>1e3?0:e.status),pe.status=0===o?204:o,pe.reason=0===o?"Server resumed the connection or down.":"OK",clearTimeout(n.id),n.reconnectId&&(clearTimeout(n.reconnectId),delete n.reconnectId),t>0?fe.reconnectId=setTimeout(function(){q(n)},t):q(n)}}function H(e){e.state="re-connecting",ae(e)}function X(e){e.state="openAfterResume",ae(e),e.state="messageReceived"}function F(e){"polling"!==e.transport?(be=J(e)).open():J(e).open()}function J(n){var t=fe;null!=n&&void 0!==n&&(t=n);var o=t.transport,r=0,a=new window.XDomainRequest,i=function(){"long-polling"===t.transport&&t.reconnect&&(-1===t.maxRequest||t.requestCount++<t.maxRequest)&&(a.status=200,F(t))},s=t.rewriteURL||function(e){var n=/(?:^|;\s*)(JSESSIONID|PHPSESSID)=([^;]*)/.exec(document.cookie);switch(n&&n[1]){case"JSESSIONID":return e.replace(/;jsessionid=[^\?]*|(\?)|$/,";jsessionid="+n[2]+"$1");case"PHPSESSID":return e.replace(/\?PHPSESSID=[^&]*&?|\?|$/,"?PHPSESSID="+n[2]+"&").replace(/&$/,"")}return e};a.onprogress=function(){l(a)},a.onerror=function(){"polling"!==t.transport&&(f(),ye++<t.maxReconnectOnClose?t.reconnectInterval>0?t.reconnectId=setTimeout(function(){y("re-connecting",n.transport,n),F(t)},t.reconnectInterval):(y("re-connecting",n.transport,n),F(t)):L(0,"maxReconnectOnClose reached"))},a.onload=function(){};var l=function(n){clearTimeout(t.id);var a=n.responseText;if(a=a.substring(r),r+=a.length,"polling"!==o){O(t);var s=U(a,t,pe);if("long-polling"===o&&0===e.util.trim(a).length)return;t.executeCallbackBeforeReconnect&&i(),s||oe(pe.responseBody,"messageReceived",200,o),t.executeCallbackBeforeReconnect||i()}};return{open:function(){var e=t.url;null!=t.dispatchUrl&&(e+=t.dispatchUrl),e=M(t,e),a.open(t.method,s(e)),"GET"===t.method?a.send():a.send(t.data),t.connectTimeout>0&&(t.id=setTimeout(function(){0===t.requestCount&&(f(),oe("Connect timeout","closed",200,t.transport))},t.connectTimeout))},close:function(){a.abort()}}}function W(e){(be=_(e)).open()}function _(n){var t=fe;null!=n&&void 0!==n&&(t=n);var o,r=new window.ActiveXObject("htmlfile");r.open(),r.close();var a=t.url;return null!=t.dispatchUrl&&(a+=t.dispatchUrl),"polling"!==t.transport&&(pe.transport=t.transport),{open:function(){var n=r.createElement("iframe");a=M(t),""!==t.data&&(a+="&X-Atmosphere-Post-Body="+encodeURIComponent(t.data)),a=e.util.prepareURL(a),n.src=a,r.body.appendChild(n);var i=n.contentDocument||n.contentWindow.document;o=e.util.iterate(function(){try{if(!i.firstChild)return;var n=i.body?i.body.lastChild:i;n.omgThisIsBroken;var a=function(){var e=n.cloneNode(!0);e.appendChild(i.createTextNode("."));var t=e.innerText;return t=t.substring(0,t.length-1)};if(!i.body||!i.body.firstChild||"pre"!==i.body.firstChild.nodeName.toLowerCase()){var s=i.head||i.getElementsByTagName("head")[0]||i.documentElement||i,l=i.createElement("script");l.text="document.write('<plaintext>')",s.insertBefore(l,s.firstChild),s.removeChild(l),n=i.body.lastChild}return t.closed&&(t.isReopen=!0),o=e.util.iterate(function(){var e=a();if(e.length>t.lastIndex){if(O(fe),pe.status=200,pe.error=null,n.innerText="",U(e,t,pe))return"";oe(pe.responseBody,"messageReceived",200,t.transport)}if(t.lastIndex=0,"complete"===i.readyState)return se(!0),y("re-connecting",t.transport,t),t.reconnectInterval>0?t.reconnectId=setTimeout(function(){W(t)},t.reconnectInterval):W(t),!1},null),!1}catch(e){return pe.error=!0,y("re-connecting",t.transport,t),ye++<t.maxReconnectOnClose?t.reconnectInterval>0?t.reconnectId=setTimeout(function(){W(t)},t.reconnectInterval):W(t):L(0,"maxReconnectOnClose reached"),r.execCommand("Stop"),r.close(),!1}})},close:function(){o&&o(),r.execCommand("Stop"),se(!0)}}}function $(n){null!=Ce?G(n):null!=he||null!=me?Q(n):null!=be?V(n):null!=ve?Y(n):null!=ge?ne(n):(L(0,"No suspended connection available"),e.util.error("No suspended connection available. Make sure atmosphere.subscribe has been called and request.onOpen invoked before trying to push data"))}function z(e,n){n||(n=ee(e)),n.transport="polling",n.method="GET",n.withCredentials=!1,n.reconnect=!1,n.force=!0,n.suspend=!1,n.timeout=1e3,q(n)}function G(e){Ce.send(e)}function K(n){if(0!==n.length)try{Ce?Ce.localSend(n):ce&&ce.signal("localMessage",e.util.stringifyJSON({id:xe,event:n}))}catch(n){e.util.error(n)}}function Q(e){q(ee(e))}function V(n){if(fe.enableXDR&&e.util.checkCORSSupport()){var t=ee(n);t.reconnect=!1,T(t)}else Q(n)}function Y(e){Q(e)}function Z(e){var n=e;return"object"==typeof n&&(n=e.data),n}function ee(n){var t=Z(n),o={connected:!1,timeout:6e4,method:"POST",url:fe.url,contentType:fe.contentType,headers:fe.headers,reconnect:!0,callback:null,data:t,suspend:!1,maxRequest:-1,logLevel:"info",requestCount:0,withCredentials:fe.withCredentials,async:fe.async,transport:"polling",isOpen:!0,attachHeadersAsQueryString:!0,enableXDR:fe.enableXDR,uuid:fe.uuid,dispatchUrl:fe.dispatchUrl,enableProtocol:!1,messageDelimiter:"|",trackMessageLength:fe.trackMessageLength,maxReconnectOnClose:fe.maxReconnectOnClose,heartbeatTimer:fe.heartbeatTimer,heartbeat:fe.heartbeat};return"object"==typeof n&&(o=e.util.extend(o,n)),o}function ne(n){var t,o=e.util.isBinary(n)?n:Z(n);try{if(t=null!=fe.dispatchUrl?fe.webSocketPathDelimiter+fe.dispatchUrl+fe.webSocketPathDelimiter+o:o,!ge.canSendMessage)return void e.util.error("WebSocket not connected.");ge.send(t)}catch(e){ge.onclose=function(e){},f(),B("Websocket failed. Downgrading to "+fe.fallbackTransport+" and resending "+n),Q(n)}}function te(n){var t=e.util.parseJSON(n);t.id!==xe&&(void 0!==fe.onLocalMessage?fe.onLocalMessage(t.event):void 0!==e.util.onLocalMessage&&e.util.onLocalMessage(t.event))}function oe(e,n,t,o){pe.responseBody=e,pe.transport=o,pe.status=t,pe.state=n,le()}function re(e,n){if(n.readResponsesHeaders)try{var t=e.getResponseHeader("X-Atmosphere-tracking-id");t&&null!=t&&(n.uuid=t.split(" ").pop())}catch(e){}else n.enableProtocol||(n.uuid=xe)}function ae(n){ie(n,fe),ie(n,e.util)}function ie(e,n){switch(e.state){case"messageReceived":l("Firing onMessage"),ye=0,void 0!==n.onMessage&&n.onMessage(e),void 0!==n.onmessage&&n.onmessage(e);break;case"error":l("Firing onError, reasonPhrase: "+(void 0!==e.reasonPhrase?e.reasonPhrase:"n/a")),void 0!==n.onError&&n.onError(e),void 0!==n.onerror&&n.onerror(e);break;case"opening":delete fe.closed,l("Firing onOpen"),void 0!==n.onOpen&&n.onOpen(e),void 0!==n.onopen&&n.onopen(e);break;case"messagePublished":l("Firing messagePublished"),void 0!==n.onMessagePublished&&n.onMessagePublished(e);break;case"re-connecting":l("Firing onReconnect"),void 0!==n.onReconnect&&n.onReconnect(fe,e);break;case"closedByClient":l("Firing closedByClient"),void 0!==n.onClientTimeout&&n.onClientTimeout(fe);break;case"re-opening":delete fe.closed,l("Firing onReopen"),void 0!==n.onReopen&&n.onReopen(fe,e);break;case"fail-to-reconnect":l("Firing onFailureToReconnect"),void 0!==n.onFailureToReconnect&&n.onFailureToReconnect(fe,e);break;case"unsubscribe":case"closed":void 0!==fe.closed&&fe.closed?l("Request already closed, not firing onClose ("+e.state+" case)"):(l("Firing onClose ("+e.state+" case)"),void 0!==n.onClose&&n.onClose(e),void 0!==n.onclose&&n.onclose(e)),fe.closed=!0;break;case"openAfterResume":void 0!==n.onOpenAfterResume&&n.onOpenAfterResume(fe)}}function se(e){"closed"!==pe.state&&(pe.state="closed",pe.responseBody="",pe.messages=[],pe.status=e?200:501,le())}function le(){null==Ce&&null!=Re&&Re(pe.responseBody),fe.reconnect=fe.mrequest;for(var n="string"==typeof pe.responseBody,t=n&&fe.trackMessageLength?pe.messages.length>0?pe.messages:[""]:new Array(pe.responseBody),r=0;r<t.length;r++)if(!(t.length>1&&0===t[r].length||(pe.responseBody=n?e.util.trim(t[r]):t[r],null==Ce&&null!=Re&&Re(pe.responseBody),(0===pe.responseBody.length||n&&ke===pe.responseBody)&&"messageReceived"===pe.state))){if(ae(pe),o.length>0){s("debug")&&e.util.debug("Invoking "+o.length+" global callbacks: "+pe.state);try{e.util.each(o,function(e,n){n(pe)})}catch(n){e.util.log(fe.logLevel,["Callback exception"+n])}}if("function"==typeof fe.callback){s("debug")&&e.util.debug("Invoking request callbacks");try{fe.callback(pe)}catch(n){e.util.log(fe.logLevel,["Callback exception"+n])}}}}var ce,ue,de,fe={timeout:3e5,method:"GET",headers:{},contentType:"",callback:null,url:"",data:"",suspend:!0,maxRequest:-1,reconnect:!0,maxStreamingLength:1e7,lastIndex:0,logLevel:"info",requestCount:0,fallbackMethod:"GET",fallbackTransport:"streaming",transport:"long-polling",webSocketImpl:null,webSocketBinaryType:null,dispatchUrl:null,webSocketPathDelimiter:"@@",enableXDR:!1,rewriteURL:!1,attachHeadersAsQueryString:!0,executeCallbackBeforeReconnect:!1,readyState:0,withCredentials:!1,trackMessageLength:!1,messageDelimiter:"|",connectTimeout:-1,reconnectInterval:0,dropHeaders:!0,uuid:0,async:!0,shared:!1,readResponsesHeaders:!1,maxReconnectOnClose:5,enableProtocol:!0,disableDisconnect:!1,pollingInterval:0,heartbeat:{client:null,server:null},ackInterval:0,closeAsync:!1,reconnectOnServerError:!0,handleOnlineOffline:!0,maxWebsocketErrorRetries:1,curWebsocketErrorRetries:0,onError:function(e){},onClose:function(e){},onOpen:function(e){},onMessage:function(e){},onReopen:function(e,n){},onReconnect:function(e,n){},onMessagePublished:function(e){},onTransportFailure:function(e,n){},onLocalMessage:function(e){},onFailureToReconnect:function(e,n){},onClientTimeout:function(e){},onOpenAfterResume:function(e){}},pe={status:200,reasonPhrase:"OK",responseBody:"",messages:[],headers:[],state:"messageReceived",transport:"polling",error:null,request:null,partialMessage:"",errorHandled:!1,closedByClientTimeout:!1,ffTryingReconnect:!1},ge=null,me=null,he=null,be=null,ve=null,we=!0,ye=0,Te=0,ke="X",Se=!1,Re=null,Ce=null,xe=e.util.now();g(t),this.subscribe=function(e){g(e),b()},this.execute=function(){b()},this.close=function(){d()},this.disconnect=function(){u()},this.getUrl=function(){return fe.url},this.push=function(e,n){if(null!=n){var t=fe.dispatchUrl;fe.dispatchUrl=n,$(e),fe.dispatchUrl=t}else $(e)},this.getUUID=function(){return fe.uuid},this.pushLocal=function(e){K(e)},this.enableProtocol=function(e){return fe.enableProtocol},this.init=function(){a()},this.request=fe,this.response=pe}},e.subscribe=function(n,o,a){"function"==typeof o&&e.addCallback(o),"string"!=typeof n?a=n:a.url=n,r=void 0!==a&&void 0!==a.uuid?a.uuid:0;var i=new e.AtmosphereRequest(a);return i.execute(),t[t.length]=i,i},e.unsubscribe=function(){if(t.length>0)for(var e=[].concat(t),n=0;n<e.length;n++){var r=e[n];r.close(),clearTimeout(r.response.request.id),r.heartbeatTimer&&clearTimeout(r.heartbeatTimer)}t=[],o=[]},e.unsubscribeUrl=function(e){var n=-1;if(t.length>0)for(var o=0;o<t.length;o++){var r=t[o];if(r.getUrl()===e){r.close(),clearTimeout(r.response.request.id),r.heartbeatTimer&&clearTimeout(r.heartbeatTimer),n=o;break}}n>=0&&t.splice(n,1)},e.addCallback=function(n){-1===e.util.inArray(n,o)&&o.push(n)},e.removeCallback=function(n){var t=e.util.inArray(n,o);-1!==t&&o.splice(t,1)},e.util={browser:{},parseHeaders:function(e){for(var n,t=/^(.*?):[ \t]*([^\r\n]*)\r?$/gm,o={};n=t.exec(e);)o[n[1]]=n[2];return o},now:function(){return(new Date).getTime()},isArray:function(e){return"[object Array]"===Object.prototype.toString.call(e)},inArray:function(e,n){if(!Array.prototype.indexOf){for(var t=n.length,o=0;o<t;++o)if(n[o]===e)return o;return-1}return n.indexOf(e)},isBinary:function(e){return/^\[object\s(?:Blob|ArrayBuffer|.+Array)\]$/.test(Object.prototype.toString.call(e))},isFunction:function(e){return"[object Function]"===Object.prototype.toString.call(e)},getAbsoluteURL:function(e){if(void 0===document.createElement)return e;var n=document.createElement("div");return n.innerHTML='<a href="'+e+'"/>',encodeURI(decodeURI(n.firstChild.href))},prepareURL:function(n){var t=e.util.now(),o=n.replace(/([?&])_=[^&]*/,"$1_="+t);return o+(o===n?(/\?/.test(n)?"&":"?")+"_="+t:"")},trim:function(e){return String.prototype.trim?e.toString().trim():e.toString().replace(/(?:(?:^|\n)\s+|\s+(?:$|\n))/g,"").replace(/\s+/g," ")},param:function(n){function t(n,t){t=e.util.isFunction(t)?t():null==t?"":t,a.push(encodeURIComponent(n)+"="+encodeURIComponent(t))}function o(n,r){var a;if(e.util.isArray(r))e.util.each(r,function(e,r){/\[\]$/.test(n)?t(n,r):o(n+"["+("object"==typeof r?e:"")+"]",r)});else if("[object Object]"===Object.prototype.toString.call(r))for(a in r)o(n+"["+a+"]",r[a]);else t(n,r)}var r,a=[];for(r in n)o(r,n[r]);return a.join("&").replace(/%20/g,"+")},storage:function(){try{return!(!window.localStorage||!window.StorageEvent)}catch(e){return!1}},iterate:function(e,n){var t;return n=n||0,function o(){t=setTimeout(function(){!1!==e()&&o()},n)}(),function(){clearTimeout(t)}},each:function(n,t,o){if(n){var r=0,a=n.length,i=e.util.isArray(n);if(o){if(i)for(;r<a&&!1!==t.apply(n[r],o);r++);else for(r in n)if(!1===t.apply(n[r],o))break}else if(i)for(;r<a&&!1!==t.call(n[r],r,n[r]);r++);else for(r in n)if(!1===t.call(n[r],r,n[r]))break;return n}},extend:function(e){var n,t,o;for(n=1;n<arguments.length;n++)if(null!=(t=arguments[n]))for(o in t)e[o]=t[o];return e},on:function(e,n,t){e.addEventListener?e.addEventListener(n,t,!1):e.attachEvent&&e.attachEvent("on"+n,t)},off:function(e,n,t){e.removeEventListener?e.removeEventListener(n,t,!1):e.detachEvent&&e.detachEvent("on"+n,t)},log:function(e,n){if(window.console){var t=window.console[e];"function"==typeof t&&t.apply(window.console,n)}},warn:function(){e.util.log("warn",arguments)},info:function(){e.util.log("info",arguments)},debug:function(){e.util.log("debug",arguments)},error:function(){e.util.log("error",arguments)},xhr:function(){try{return new window.XMLHttpRequest}catch(e){try{return new window.ActiveXObject("Microsoft.XMLHTTP")}catch(e){}}},parseJSON:function(e){return e?window.JSON&&window.JSON.parse?window.JSON.parse(e):new Function("return "+e)():null},stringifyJSON:function(e){function n(e){return'"'+e.replace(o,function(e){var n=r[e];return"string"==typeof n?n:"\\u"+("0000"+e.charCodeAt(0).toString(16)).slice(-4)})+'"'}function t(e){return e<10?"0"+e:e}var o=/[\\\"\x00-\x1f\x7f-\x9f\u00ad\u0600-\u0604\u070f\u17b4\u17b5\u200c-\u200f\u2028-\u202f\u2060-\u206f\ufeff\ufff0-\uffff]/g,r={"\b":"\\b","\t":"\\t","\n":"\\n","\f":"\\f","\r":"\\r",'"':'\\"',"\\":"\\\\"};return window.JSON&&window.JSON.stringify?window.JSON.stringify(e):function e(o,r){var i,s,l,c,u=r[o],d=typeof u;switch(u&&"object"==typeof u&&"function"==typeof u.toJSON&&(d=typeof(u=u.toJSON(o))),d){case"string":return n(u);case"number":return isFinite(u)?String(u):"null";case"boolean":return String(u);case"object":if(!u)return"null";switch(Object.prototype.toString.call(u)){case"[object Date]":return isFinite(u.valueOf())?'"'+u.getUTCFullYear()+"-"+t(u.getUTCMonth()+1)+"-"+t(u.getUTCDate())+"T"+t(u.getUTCHours())+":"+t(u.getUTCMinutes())+":"+t(u.getUTCSeconds())+'Z"':"null";case"[object Array]":for(l=u.length,c=[],i=0;i<l;i++)c.push(e(i,u)||"null");return"["+c.join(",")+"]";default:c=[];for(i in u)a.call(u,i)&&(s=e(i,u))&&c.push(n(i)+":"+s);return"{"+c.join(",")+"}"}}}("",{"":e})},checkCORSSupport:function(){if(e.util.browser.msie&&!window.XDomainRequest&&+e.util.browser.version.split(".")[0]<11)return!0;if(e.util.browser.opera&&+e.util.browser.version.split(".")<12)return!0;if("KreaTVWebKit/531"===e.util.trim(navigator.userAgent).slice(0,16))return!0;if("kreatel"===e.util.trim(navigator.userAgent).slice(-7).toLowerCase())return!0;var n=navigator.userAgent.toLowerCase().match(/.+android ([0-9]{1,2})/i),t=parseInt(n&&n[0]||-1,10);return!isNaN(t)&&t>-1&&t<3}},e.util.now(),function(){var n=navigator.userAgent.toLowerCase(),t=/(chrome)[ \/]([\w.]+)/.exec(n)||/(opera)(?:.*version|)[ \/]([\w.]+)/.exec(n)||/(msie) ([\w.]+)/.exec(n)||/(trident)(?:.*? rv:([\w.]+)|)/.exec(n)||n.indexOf("android")<0&&/version\/(.+) (safari)/.exec(n)||n.indexOf("compatible")<0&&/(mozilla)(?:.*? rv:([\w.]+)|)/.exec(n)||[];"safari"===t[2]&&(t[2]=t[1],t[1]="safari"),e.util.browser[t[1]||""]=!0,e.util.browser.version=t[2]||"0",e.util.browser.vmajor=e.util.browser.version.split(".")[0],e.util.browser.trident&&(e.util.browser.msie=!0),(e.util.browser.msie||e.util.browser.mozilla&&1==+e.util.browser.version.split(".")[0])&&(e.util.storage=!1)}(),e.callbacks={unload:function(){e.util.debug(new Date+" Atmosphere: unload event"),e.unsubscribe()},beforeUnload:function(){e.util.debug(new Date+" Atmosphere: beforeunload event"),e._beforeUnloadState=!0,setTimeout(function(){e.util.debug(new Date+" Atmosphere: beforeunload event timeout reached. Reset _beforeUnloadState flag"),e._beforeUnloadState=!1},5e3)},offline:function(){if(e.util.debug(new Date+" Atmosphere: offline event"),n=!0,t.length>0)for(var o=[].concat(t),r=0;r<o.length;r++){var a=o[r];a.request.handleOnlineOffline&&(a.close(),clearTimeout(a.response.request.id),a.heartbeatTimer&&clearTimeout(a.heartbeatTimer))}},online:function(){if(e.util.debug(new Date+" Atmosphere: online event"),t.length>0)for(var o=0;o<t.length;o++)t[o].request.handleOnlineOffline&&(t[o].init(),t[o].execute());n=!1}},e.bindEvents=function(){e.util.on(window,"unload",e.callbacks.unload),e.util.on(window,"beforeunload",e.callbacks.beforeUnload),e.util.on(window,"offline",e.callbacks.offline),e.util.on(window,"online",e.callbacks.online)},e.unbindEvents=function(){e.util.off(window,"unload",e.callbacks.unload),e.util.off(window,"beforeunload",e.callbacks.beforeUnload),e.util.off(window,"offline",e.callbacks.offline),e.util.off(window,"online",e.callbacks.online)},e.bindEvents(),e});